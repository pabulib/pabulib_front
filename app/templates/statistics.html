{% extends 'base.html' %}

{% block bodyClass %}statistics{% endblock %}
{% block title %}Pabulib – Statistics{% endblock %}

{% block body %}
<div class="container py-4" style="max-width: 900px;">
  <h1 class="mb-4">Statistics</h1>

  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="fs-1">{{ formatted.files }}</div>
          <div class="text-muted">Files</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="fs-1">{{ formatted.countries }}</div>
          <div class="text-muted">Countries</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="fs-1">{{ formatted.cities }}</div>
          <div class="text-muted">Cities</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="fs-1">{{ formatted.projects }}</div>
          <div class="text-muted">Projects</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="fs-1">{{ formatted.votes }}</div>
          <div class="text-muted">Votes</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <div class="fs-1">{{ formatted.funded }}</div>
          <div class="text-muted">Projects funded</div>
        </div>
      </div>
    </div>
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="me-3">
              <div class="fw-semibold">Budgets by currency</div>
              <div class="small text-muted">Sum of file budgets per currency</div>
            </div>
            <div class="d-flex flex-wrap gap-2">
              {% for b in budgets_list %}
              <span class="badge text-bg-light border">
                <span class="fw-semibold">{{ b.currency }}</span>
                <span class="ms-1">{{ b.amount }}</span>
              </span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-header">Files per year</div>
        <div class="card-body"><canvas id="chartYear" style="height: 120px"></canvas></div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-header">Vote types</div>
        <div class="card-body"><canvas id="chartTypes" style="height: 140px"></canvas></div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-header">Votes by country</div>
        <div class="card-body"><canvas id="chartVotesCountry" style="height: 140px"></canvas></div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <span>Budget by country</span>
          <select id="currencySelect" class="form-select form-select-sm" style="width:auto"></select>
        </div>
        <div class="card-body"><canvas id="chartBudgetCountry" style="height: 140px"></canvas></div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-header">Top cities by votes</div>
        <div class="card-body"><canvas id="chartTopCities" style="height: 140px"></canvas></div>
      </div>
    </div>
  </div>
</div>

<script id="stats-series" type="application/json">{{ series | tojson }}</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const statsSeries = JSON.parse(document.getElementById('stats-series').textContent);
  function mkColors(n, alpha=0.7) {
    const base = ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc948','#b07aa1','#ff9da7','#9c755f','#bab0ab'];
    const out = [];
    for (let i=0;i<n;i++) {
      const c = base[i % base.length];
      if (alpha < 1) {
        // convert hex to rgba with alpha
        const r = parseInt(c.slice(1,3),16), g=parseInt(c.slice(3,5),16), b=parseInt(c.slice(5,7),16);
        out.push(`rgba(${r},${g},${b},${alpha})`);
      } else {
        out.push(c);
      }
    }
    return out;
  }

  // Files per year (bar)
  (function(){
    const ctx = document.getElementById('chartYear');
  const labels = statsSeries.files_per_year.map(d => d.label);
  const data = statsSeries.files_per_year.map(d => d.value);
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '# files', data, backgroundColor: mkColors(data.length, 0.7), maxBarThickness: 32 }] },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { font: { size: 10 } } }, x: { ticks: { font: { size: 10 } } } }, plugins: { legend: { labels: { font: { size: 10 } } } } }
    });
  })();

  // Vote types (doughnut)
  (function(){
    const ctx = document.getElementById('chartTypes');
  const labels = statsSeries.vote_types.map(d => d.label);
  const data = statsSeries.vote_types.map(d => d.value);
    new Chart(ctx, {
      type: 'doughnut',
      data: { labels, datasets: [{ data, backgroundColor: mkColors(data.length) }] },
      options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } }
    });
  })();

  // Votes by country (horizontal bar)
  ;(function(){
    const ctx = document.getElementById('chartVotesCountry');
  const labels = statsSeries.votes_per_country.map(d => d.label);
  const data = statsSeries.votes_per_country.map(d => d.value);
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Votes', data, backgroundColor: mkColors(data.length, 0.7), maxBarThickness: 32 }] },
      options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { font: { size: 10 } } }, y: { ticks: { font: { size: 10 } } } }, plugins: { legend: { labels: { font: { size: 10 } } } } }
    });
  })();

  // Budget by country (horizontal bar) with currency selector
  ;(function(){
    const ctx = document.getElementById('chartBudgetCountry');
    const sel = document.getElementById('currencySelect');
    const currencies = statsSeries.available_currencies || [];
    currencies.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
    const pick = currencies[0] || '—';
    sel.value = pick;
    const datasetFor = (cur) => {
      const arr = (statsSeries.budget_per_country_by_currency && statsSeries.budget_per_country_by_currency[cur]) || [];
      return {
        labels: arr.map(d => d.label),
        data: arr.map(d => d.value)
      };
    };
    let base = datasetFor(pick);
    const chart = new Chart(ctx, {
      type: 'bar',
      data: { labels: base.labels, datasets: [{ label: `Budget (${pick})`, data: base.data, backgroundColor: mkColors(base.data.length, 0.7), maxBarThickness: 32 }] },
      options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { font: { size: 10 } } }, y: { ticks: { font: { size: 10 } } } }, plugins: { legend: { labels: { font: { size: 10 } } } } }
    });
    sel.addEventListener('change', () => {
      const cur = sel.value;
      const ds = datasetFor(cur);
      chart.data.labels = ds.labels;
      chart.data.datasets[0].data = ds.data;
      chart.data.datasets[0].label = `Budget (${cur})`;
      chart.update();
    });
  })();

  // Top cities by votes (bar)
  (function(){
    const ctx = document.getElementById('chartTopCities');
  const labels = statsSeries.top_cities_by_votes.map(d => d.label);
  const data = statsSeries.top_cities_by_votes.map(d => d.value);
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Votes', data, backgroundColor: mkColors(data.length, 0.7), maxBarThickness: 32 }] },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { font: { size: 10 } } }, x: { ticks: { font: { size: 10 } } } }, plugins: { legend: { display: false } } }
    });
  })();
</script>
{% endblock %}

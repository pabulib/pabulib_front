{% extends 'base.html' %}

{% block bodyClass %}statistics{% endblock %}
{% block title %}Pabulib – Statistics{% endblock %}

{% block body %}
<section class="max-w-4xl mx-auto px-4">
  <div class="flex justify-center">
    <div class="w-full max-w-4xl bg-white rounded-lg shadow-lg p-8 mt-8 mb-32">
      <h1 class="text-3xl font-bold text-slate-800 mb-6">Statistics</h1>

  <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
      <div class="text-4xl font-bold text-slate-800 mb-1">{{ formatted.files }}</div>
      <div class="text-gray-600 text-sm">Files</div>
    </div>
    <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
      <div class="text-4xl font-bold text-slate-800 mb-1">{{ formatted.countries }}</div>
      <div class="text-gray-600 text-sm">Countries</div>
    </div>
    <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
      <div class="text-4xl font-bold text-slate-800 mb-1">{{ formatted.cities }}</div>
      <div class="text-gray-600 text-sm">Cities</div>
    </div>
    <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
      <div class="text-4xl font-bold text-slate-800 mb-1">{{ formatted.projects }}</div>
      <div class="text-gray-600 text-sm">Projects</div>
    </div>
    <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
      <div class="text-4xl font-bold text-slate-800 mb-1">{{ formatted.votes }}</div>
      <div class="text-gray-600 text-sm">Votes</div>
    </div>
    <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
  <div class="text-4xl font-bold text-slate-800 mb-1">{{ formatted.selected }}</div>
  <div class="text-gray-600 text-sm">Projects selected</div>
    </div>
    <div class="col-span-full">
      <div class="bg-gray-50 rounded-lg border border-gray-200 p-6">
        <div class="flex justify-between items-center flex-wrap gap-4">
          <div>
            <div class="font-semibold text-gray-800 text-lg">Budgets by currency</div>
            <div class="text-sm text-gray-600 mt-1">Sum of file budgets per currency</div>
          </div>
          <div class="flex flex-wrap gap-3">
            {% for b in budgets_list %}
            <span class="inline-flex items-center px-3 py-2 rounded-md bg-white border border-gray-300 shadow-sm">
              <span class="font-semibold text-slate-800">{{ b.currency }}</span>
              <span class="ml-2 text-gray-700">{{ b.amount }}</span>
            </span>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-6">
    <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
      <div class="bg-gray-200 px-4 py-3 text-sm font-medium text-gray-700">Files per year</div>
      <div class="p-4"><canvas id="chartYear" class="h-32"></canvas></div>
    </div>
    <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
      <div class="bg-gray-200 px-4 py-3 text-sm font-medium text-gray-700">Vote types</div>
      <div class="p-4"><canvas id="chartTypes" class="h-36"></canvas></div>
    </div>
    <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
      <div class="bg-gray-200 px-4 py-3 text-sm font-medium text-gray-700">Votes by country</div>
      <div class="p-4"><canvas id="chartVotesCountry" class="h-36"></canvas></div>
    </div>
    <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
      <div class="bg-gray-200 px-4 py-3 text-sm font-medium text-gray-700 flex items-center justify-between">
        <span>Budget by country</span>
        <select id="currencySelect" class="text-xs px-2 py-1 border border-gray-300 rounded bg-white w-auto"></select>
      </div>
      <div class="p-4"><canvas id="chartBudgetCountry" class="h-36"></canvas></div>
    </div>
    <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
      <div class="bg-gray-200 px-4 py-3 text-sm font-medium text-gray-700">Top cities by votes</div>
      <div class="p-4"><canvas id="chartTopCities" class="h-36"></canvas></div>
    </div>
  </div>
    </div>
  </div>
</section>

<script id="stats-series" type="application/json">{{ series | tojson }}</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const statsSeries = JSON.parse(document.getElementById('stats-series').textContent);
  function mkColors(n, alpha=0.7) {
    const base = ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc948','#b07aa1','#ff9da7','#9c755f','#bab0ab'];
    const out = [];
    for (let i=0;i<n;i++) {
      const c = base[i % base.length];
      if (alpha < 1) {
        // convert hex to rgba with alpha
        const r = parseInt(c.slice(1,3),16), g=parseInt(c.slice(3,5),16), b=parseInt(c.slice(5,7),16);
        out.push(`rgba(${r},${g},${b},${alpha})`);
      } else {
        out.push(c);
      }
    }
    return out;
  }

  // Files per year (bar)
  (function(){
    const ctx = document.getElementById('chartYear');
  const labels = statsSeries.files_per_year.map(d => d.label);
  const data = statsSeries.files_per_year.map(d => d.value);
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '# files', data, backgroundColor: mkColors(data.length, 0.7), maxBarThickness: 32 }] },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { font: { size: 10 } } }, x: { ticks: { font: { size: 10 } } } }, plugins: { legend: { labels: { font: { size: 10 } } } } }
    });
  })();

  // Vote types (doughnut)
  (function(){
    const ctx = document.getElementById('chartTypes');
  const labels = statsSeries.vote_types.map(d => d.label);
  const data = statsSeries.vote_types.map(d => d.value);
    new Chart(ctx, {
      type: 'doughnut',
      data: { labels, datasets: [{ data, backgroundColor: mkColors(data.length) }] },
      options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { font: { size: 10 } } } } }
    });
  })();

  // Votes by country (horizontal bar)
  ;(function(){
    const ctx = document.getElementById('chartVotesCountry');
  const labels = statsSeries.votes_per_country.map(d => d.label);
  const data = statsSeries.votes_per_country.map(d => d.value);
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Votes', data, backgroundColor: mkColors(data.length, 0.7), maxBarThickness: 32 }] },
      options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { font: { size: 10 } } }, y: { ticks: { font: { size: 10 } } } }, plugins: { legend: { labels: { font: { size: 10 } } } } }
    });
  })();

  // Budget by country (horizontal bar) with currency selector
  ;(function(){
    const ctx = document.getElementById('chartBudgetCountry');
    const sel = document.getElementById('currencySelect');
    const currencies = statsSeries.available_currencies || [];
    currencies.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
    const pick = currencies[0] || '—';
    sel.value = pick;
    const datasetFor = (cur) => {
      const arr = (statsSeries.budget_per_country_by_currency && statsSeries.budget_per_country_by_currency[cur]) || [];
      return {
        labels: arr.map(d => d.label),
        data: arr.map(d => d.value)
      };
    };
    let base = datasetFor(pick);
    const chart = new Chart(ctx, {
      type: 'bar',
      data: { labels: base.labels, datasets: [{ label: `Budget (${pick})`, data: base.data, backgroundColor: mkColors(base.data.length, 0.7), maxBarThickness: 32 }] },
      options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { font: { size: 10 } } }, y: { ticks: { font: { size: 10 } } } }, plugins: { legend: { labels: { font: { size: 10 } } } } }
    });
    sel.addEventListener('change', () => {
      const cur = sel.value;
      const ds = datasetFor(cur);
      chart.data.labels = ds.labels;
      chart.data.datasets[0].data = ds.data;
      chart.data.datasets[0].label = `Budget (${cur})`;
      chart.update();
    });
  })();

  // Top cities by votes (bar)
  (function(){
    const ctx = document.getElementById('chartTopCities');
  const labels = statsSeries.top_cities_by_votes.map(d => d.label);
  const data = statsSeries.top_cities_by_votes.map(d => d.value);
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Votes', data, backgroundColor: mkColors(data.length, 0.7), maxBarThickness: 32 }] },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { font: { size: 10 } } }, x: { ticks: { font: { size: 10 } } } }, plugins: { legend: { display: false } } }
    });
  })();
</script>
{% include 'footer.html' %}
{% endblock %}

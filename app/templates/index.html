{% extends 'base.html' %}

{% block bodyClass %}search{% endblock %}
{% block title %}Pabulib – Search{% endblock %}

{% block body %}
    <div class="layout">
      <!-- Mobile-only Filter toggle button -->
      <div class="md:hidden flex items-center justify-between -mt-2 mb-2">
        <button id="openFilters" aria-expanded="false" class="inline-flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg shadow-sm text-slate-700">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12 10 19 14 21 14 12 22 3"></polygon></svg>
          Filters
        </button>
      </div>
      <aside class="sidebar" id="filtersPanel" aria-hidden="false">
        <!-- Drawer header (mobile) with close button -->
        <div class="md:hidden flex items-center justify-between sticky top-0 bg-white pb-2 pt-1 -mt-1" style="z-index:1">
          <div class="font-semibold text-slate-700">Filters</div>
          <button id="closeFilters" class="inline-flex items-center justify-center w-8 h-8 rounded-md border border-slate-200 text-slate-600" aria-label="Close filters">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
        <div class="field">
          <label>Order by</label>
          <div class="row">
            <select id="orderBy">
              <option value="quality" selected>Quality</option>
              <option value="votes"># votes</option>
              <option value="projects"># projects</option>
              <option value="budget">Budget</option>
              <option value="year">Year</option>
            </select>
            <button type="button" id="orderDir" title="Toggle sort direction">⇅</button>
          </div>
          <details class="micro-note">
            <summary>Quality score (QS)</summary>
            <div>
              QS is a simple heuristic to surface richer datasets. Higher is better.
              <br><br>
              <span class="formula">QS = (avg vote length)<sup>2</sup> × (projects) × (votes)<sup>1/2</sup></span>.
            </div>
          </details>
        </div>

        <div class="field">
          <label>Country</label>
          <select id="filterCountry"><option value="">All countries</option></select>
        </div>
        <div class="field">
          <label>City</label>
          <select id="filterCity"><option value="">All cities</option></select>
        </div>
        <div class="field">
          <label>Year of election</label>
          <select id="filterYear"><option value="">All years</option></select>
        </div>

        <div class="field two">
          <label>Number of votes</label>
          <div class="range"><input id="votesMin" placeholder="Min" inputmode="numeric"><span>–</span><input id="votesMax" placeholder="Max" inputmode="numeric"></div>
        </div>
        <div class="field two">
          <label>Number of projects</label>
          <div class="range"><input id="projectsMin" placeholder="Min" inputmode="numeric"><span>–</span><input id="projectsMax" placeholder="Max" inputmode="numeric"></div>
        </div>
        <div class="field two">
          <label>Average vote length</label>
          <div class="range"><input id="lenMin" placeholder="Min" inputmode="decimal"><span>–</span><input id="lenMax" placeholder="Max" inputmode="decimal"></div>
        </div>

        <div class="field">
          <label>Vote type</label>
          <select id="filterType">
            <option value="">Any type</option>
            <option value="approval">Approval voting</option>
            <option value="cumulative">Cumulative voting</option>
            <option value="ranked">Ranked voting</option>
            <option value="k-approval">K-approval voting</option>
          </select>
        </div>
        <div class="field">
          <label>Exclude from results</label>
          <label class="checkbox"><input id="excludeFully" type="checkbox"> Fully funded projects</label>
          <label class="checkbox"><input id="excludeExperimental" type="checkbox"> Experimental datasets</label>
        </div>

        <div class="field">
          <button id="filtersClear" type="button">Clear filters</button>
        </div>
      </aside>

      <div class="container mb-32">
      <form id="downloadForm" method="post" action="{{ url_for('main.download_selected') }}">
        <header class="toolbar">
          <input id="search" class="search" placeholder="Search..." />
          <label class="select-all"><input id="selectAll" type="checkbox" /> Select all</label>
          <div class="spacer"></div>
          <div class="count"><span id="count">{{ count }}</span> PBs found</div>
          <button id="downloadBtn" class="primary" type="submit" disabled>Download selected</button>
        </header>

      {% for t in tiles %}
      <section class="tile"
        data-title="{{ t.title|e }}"
        data-webpage="{{ t.webpage_name|e }}"
        data-desc="{{ t.description|e }}"
        data-file="{{ t.file_name|e }}"
        data-country="{{ t.country|e }}"
        data-city="{{ t.city|e }}"
        data-year="{{ t.year|e }}"
        data-votes="{{ t.num_votes_raw if t.num_votes_raw is not none else '' }}"
        data-projects="{{ t.num_projects_raw if t.num_projects_raw is not none else '' }}"
        data-budget="{{ t.budget_raw if t.budget_raw is not none else '' }}"
        data-currency="{{ t.currency|e }}"
        data-type="{{ t.vote_type|e }}"
        data-vlen="{{ '%.3f' % t.vote_length_raw if t.vote_length_raw is not none else '' }}"
        data-fully="{{ '1' if t.fully_funded else '0' }}"
        data-experimental="{{ '1' if t.experimental else '0' }}"
        data-quality="{{ '%.6f' % t.quality }}"
         {% if t.num_selected_projects_raw is not none %}data-selected="{{ t.num_selected_projects_raw }}"{% endif %}
         data-rule="{{ t.rule_raw }}"
         data-edition="{{ t.edition }}"
         data-language="{{ t.language }}"
      >
        <div class="tile-header">
          <input class="row-check" type="checkbox" data-file="{{ t.file_name|e }}" />
          <h2>{{ t.title|replace('_', ' ') }}</h2>
          <div class="badges">
            <span class="qs" title="QS = (avg vote length)³ × (projects)² × (votes). Higher is better.">QS {{ t.quality_short }}</span>
            {% if t.experimental %}
            <span class="tag exp" title="Dataset marked as experimental">Experimental</span>
            {% endif %}
            {% if t.fully_funded %}
            <span class="tag funded" title="All selected projects are funded">Fully funded</span>
            {% endif %}
          </div>
          <a class="doc" href="{{ url_for('main.preview_file', filename=t.file_name) }}" title="Preview"></a>
          <a class="visualization" href="{{ url_for('main.visualize_file', filename=t.file_name) }}" title="Visualize"></a>
          <a class="download" href="{{ url_for('main.download', filename=t.file_name) }}" title="Download"></a>
        </div>
        <div class="grid head">
          <div>Description</div>
          <div># votes</div>
          <div># projects</div>
          <div>Budget</div>
          <div>Vote type</div>
          <div>Vote length</div>
        </div>
        <div class="grid">
          <div class="muted">{{ t.description }}</div>
          <div>{{ t.num_votes }}</div>
          <div>{{ t.num_projects }}</div>
          <div>
            {% if t.currency == "EUR" %}
              {{ t.budget|replace('EUR', '€') }}
            {% elif t.currency == "USD" %}
              ${{ t.budget|replace('USD', '') }}
            {% else %}
              {{ t.budget }}
            {% endif %}
          </div>
          <div>{{ t.vote_type }}</div>
          <div>{{ t.vote_length }}</div>
        </div>
      </section>
      {% endfor %}
      <div id="sentinel" class="sentinel" aria-hidden="true"></div>
    </form>
    <script src="{{ url_for('main.static', filename='app.js') }}"></script>
  </div>
    </div>
    {% include 'footer.html' %}
{% endblock %}

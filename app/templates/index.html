{% extends 'base.html' %}

{% block bodyClass %}search{% endblock %}
{% block title %}Pabulib ‚Äì Search{% endblock %}

{% block body %}
    <div class="layout">
      <!-- Mobile-only Filter toggle button -->
      <div class="md:hidden flex items-center justify-between -mt-2 mb-2">
        <button id="openFilters" aria-expanded="false" class="inline-flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg shadow-sm text-slate-700">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12 10 19 14 21 14 12 22 3"></polygon></svg>
          Filters
        </button>
      </div>
  <aside class="sidebar" id="filtersPanel" aria-hidden="true">
        <!-- Drawer header (mobile) with close button -->
        <div class="md:hidden flex items-center justify-between sticky top-0 bg-white pb-2 pt-1 -mt-1" style="z-index:1">
          <div class="font-semibold text-slate-700">Filters</div>
          <button id="closeFilters" class="inline-flex items-center justify-center w-8 h-8 rounded-md border border-slate-200 text-slate-600" aria-label="Close filters">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
        <div class="field">
          <label>Order by</label>
          <div class="row">
            <select id="orderBy">
              <option value="quality" selected>Quality</option>
              <option value="votes">Votes</option>
              <option value="projects">Projects</option>
              <option value="budget">Budget</option>
              <option value="year">Year</option>
              <option value="vote_length">Vote length</option>
            </select>
            <button type="button" id="orderDir" title="Toggle sort direction">‚áÖ</button>
          </div>
          <details class="micro-note">
            <summary>Quality score (QS)</summary>
            <div>
              QS is a simple heuristic to surface richer datasets. Higher is better.
              <br><br>
              <span class="formula">QS = (avg vote length)<sup>2</sup> √ó (projects) √ó (votes)<sup>1/2</sup></span>.
            </div>
          </details>
        </div>

        <div class="field">
          <label>Country</label>
          <select id="filterCountry"><option value="">All countries</option></select>
        </div>
        <div class="field">
          <label>City</label>
          <select id="filterCity"><option value="">All cities</option></select>
        </div>
        <div class="field">
          <label>Year of election</label>
          <select id="filterYear"><option value="">All years</option></select>
        </div>

        <div class="field two">
          <label>Number of votes</label>
          <div class="range"><input id="votesMin" placeholder="Min" inputmode="numeric"><span>‚Äì</span><input id="votesMax" placeholder="Max" inputmode="numeric"></div>
        </div>
        <div class="field two">
          <label>Number of projects</label>
          <div class="range"><input id="projectsMin" placeholder="Min" inputmode="numeric"><span>‚Äì</span><input id="projectsMax" placeholder="Max" inputmode="numeric"></div>
        </div>
        <div class="field two">
          <label>Average vote length</label>
          <div class="range"><input id="lenMin" placeholder="Min" inputmode="decimal"><span>‚Äì</span><input id="lenMax" placeholder="Max" inputmode="decimal"></div>
        </div>

        <div class="field">
          <label>Vote type</label>
          <select id="filterType">
            <option value="">Any type</option>
            <option value="approval">Approval</option>
            <option value="cumulative">Cumulative</option>
            <option value="ordinal">Ordinal</option>
            <option value="scoring">Scoring</option>
            <option value="choose-1">Choose-1</option>
          </select>
        </div>
        <div class="field">
          <label>Show datasets with</label>
          <label class="checkbox"><input id="requireGeo" type="checkbox"> <span class="badge geo" title="Includes project coordinates">Geo</span> Project coordinates</label>
          <label class="checkbox"><input id="requireTarget" type="checkbox"> <span class="badge target" title="Includes project targets">Tgt</span> Project targets</label>
          <label class="checkbox"><input id="requireCategory" type="checkbox"> <span class="badge category" title="Includes project categories">Cat</span> Project categories</label>
        </div>

        <div class="field">
          <label>Exclude datasets if</label>
          <label class="checkbox"><input id="excludeFully" type="checkbox"> Fully funded</label>
          <label class="checkbox"><input id="excludeExperimental" type="checkbox"> Experimental</label>
        </div>

        <div class="field">
          <button id="filtersClear" type="button">Clear filters</button>
        </div>
      </aside>

      <div class="container">
      <form id="downloadForm" method="post" action="{{ url_for('main.download_selected') }}" 
            data-track-form="batch_download" data-form-type="download">
        <header class="toolbar">
          <input id="search" class="search" placeholder="Search..." />
          <label class="select-all"><input id="selectAll" type="checkbox" /> Select all</label>
          <div class="spacer"></div>
          <div class="count"><span id="count">{{ count }}</span> PBs found</div>
          <button id="downloadBtn" class="primary" type="submit" disabled 
                  data-track="batch_download" data-track-category="download">Download selected</button>
        </header>

        <!-- Small hint about faster "Select all" download using pre-built archive -->
        <div class="mt-2 text-xs text-slate-500">
          Tip: Selecting "Select all" will use a pre-built archive (all_pb_files.zip) and starts faster. Individual selections are zipped on the server and may take a bit longer.
        </div>

        <!-- Information about permanent download links -->
        <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
            </svg>
            <div class="text-xs text-blue-800">
              <div class="font-medium mb-1">üìÑ Permanent Download Links</div>
              <div class="text-blue-700">
                Multi-file downloads include a <code class="px-1 py-0.5 bg-blue-100 rounded text-blue-900 font-mono">_PERMANENT_DOWNLOAD_LINK.txt</code> with a permanent URL.
                This link will always download the exact same files, even if they are updated later.
                <span class="inline-block ml-1 text-blue-600 hover:text-blue-800 cursor-help" title="The same set of files always generates the same permanent URL">‚ôªÔ∏è</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Download progress (hidden by default) -->
        <div id="downloadProgress" class="hidden mt-4">
          <div class="bg-slate-100 rounded-full h-2.5 overflow-hidden">
            <div id="dlBar" class="bg-indigo-600 h-full transition-all duration-300 ease-out" style="width: 0%"></div>
          </div>
          <div class="mt-2 text-sm text-slate-600 text-center">
            <div class="flex items-center justify-center gap-2">
              <span id="dlPhase" class="px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700">Preparing</span>
              <span id="dlText">Preparing download...</span>
              <span id="dlPercent" class="font-medium">0%</span>
            </div>
          </div>
          <div class="text-xs text-slate-500 text-center mt-2 space-y-1">
            <div id="dlFileCount" class="hidden">
              Zipping file <span id="dlCurrent">0</span> of <span id="dlTotal">0</span>
            </div>
            <div id="dlFileName" class="hidden font-mono text-slate-600 truncate max-w-md mx-auto" title=""></div>
            <div id="dlHint" class="text-slate-400">We are zipping your selection on the server. This can take a moment.</div>
          </div>
        </div>

      {% for t in tiles %}
      <section class="tile"
        data-title="{{ t.title|e }}"
        data-webpage="{{ t.webpage_name|e }}"
        data-desc="{{ t.description|e }}"
        data-file="{{ t.file_name|e }}"
        data-comments="{{ (t.comments|join(' ') if t.comments else '')|e }}"
        data-country="{{ t.country|e }}"
        data-city="{{ t.city|e }}"
        data-year="{{ t.year|e }}"
        data-votes="{{ t.num_votes_raw if t.num_votes_raw is not none else '' }}"
        data-projects="{{ t.num_projects_raw if t.num_projects_raw is not none else '' }}"
        data-budget="{{ t.budget_raw if t.budget_raw is not none else '' }}"
        data-currency="{{ t.currency|e }}"
  data-type="{{ t.vote_type|e }}"
  data-aklabel="{{ t.approval_k_label or '' }}"
  data-aktype="{{ (t.approval_k_type or '') }}"
  data-aknapsack="{{ '1' if t.approval_knapsack else '0' }}"
  data-cpts="{{ t.cumulative_points_label or '' }}"
        data-vlen="{{ '%.3f' % t.vote_length_raw if t.vote_length_raw is not none else '' }}"
        data-fully="{{ '1' if t.fully_funded else '0' }}"
        data-experimental="{{ '1' if t.experimental else '0' }}"
  data-quality="{{ '%.6f' % t.quality }}"
  data-geo="{{ '1' if t.has_geo else '0' }}"
  data-target="{{ '1' if t.has_target else '0' }}"
  data-category="{{ '1' if t.has_category else '0' }}"
         {% if t.num_selected_projects_raw is not none %}data-selected="{{ t.num_selected_projects_raw }}"{% endif %}
         data-rule="{{ t.rule_raw }}"
         data-edition="{{ t.edition }}"
         data-language="{{ t.language }}"
      >
        <div class="tile-header">
          <input class="row-check" type="checkbox" data-file="{{ t.file_name|e }}" />
          <div class="title-row">
            <h2>{{ t.title|replace('_', ' ') }}</h2>
            <div class="labels">
            {% if t.experimental %}
            <span class="tag exp" title="Dataset marked as experimental">Experimental</span>
            {% endif %}
            {% if t.fully_funded %}
            <span class="tag funded" title="All selected projects are funded">Fully funded</span>
            {% endif %}
            {% if t.has_geo %}
            <span class="tag geo" title="Dataset includes project coordinates">Geo</span>
            {% endif %}
            {% if t.has_category %}
            <span class="tag category" title="Dataset includes project categories">Cat</span>
            {% endif %}
            {% if t.has_target %}
            <span class="tag target" title="Dataset includes project targets">Tgt</span>
            {% endif %}
            </div>
          </div>
          <span class="qs" title="QS = (avg vote length)¬≥ √ó (projects)¬≤ √ó (votes). Higher is better.">QS {{ t.quality_short }}</span>
          <a class="doc" href="{{ url_for('main.preview_file', filename=t.file_name) }}" title="Preview" data-track="file_preview" data-track-category="engagement"></a>
          <a class="visualization" href="{{ url_for('main.visualize_file', filename=t.file_name) }}" title="Visualize" data-track="file_visualize" data-track-category="engagement"></a>
          <a class="download" href="{{ url_for('main.download', filename=t.file_name) }}" title="Download" 
             data-track="file_download" data-track-category="download" 
             data-filename="{{ t.file_name }}" data-download-type="single"></a>
        </div>
        <!-- Mobile compact meta row (hidden on desktop) -->
        <div class="mobile-meta" aria-hidden="true">
          <div>
            <span># votes</span>
            <strong>{{ t.num_votes }}</strong>
          </div>
          <div>
            <span># projects</span>
            <strong>{{ t.num_projects }}</strong>
          </div>
          <div>
            <span>Vote length</span>
            <strong>{{ t.vote_length }}</strong>
          </div>
        </div>
        <div class="grid head">
          <div>Description</div>
          <div>Votes</div>
          <div>Projects</div>
          <div>Budget{% if t.currency %} {{ t.currency }}{% endif %}</div>
          <div>Vote type</div>
          <div>Vote length</div>
        </div>
        <div class="grid">
          <div class="muted">{{ t.description }}</div>
          <div>{{ t.num_votes }}</div>
          <div>{{ t.num_projects }}</div>
          <div>
            {% if t.currency %}
              {{ t.budget|replace(t.currency, '')|replace('‚Ç¨','')|replace('$','')|trim }}
            {% else %}
              {{ t.budget|replace('‚Ç¨','')|replace('$','')|trim }}
            {% endif %}
          </div>
          <div>
            {% if t.vote_type and t.vote_type|lower == 'approval' %}
              app.{% if t.approval_knapsack %}, <code>knapsack</code>{% elif t.approval_k_label %}, <code>{{ t.approval_k_label|e }}</code>{% endif %}
            {% elif t.vote_type and t.vote_type|lower == 'ordinal' %}
              ord.{% if t.ordinal_k_label %}, <code>{{ t.ordinal_k_label|e }}</code>{% endif %}
            {% elif t.vote_type and t.vote_type|lower == 'cumulative' %}
              cml.{% if t.cumulative_points_label %}, <code>{{ t.cumulative_points_label|e }}</code>{% endif %}
            {% else %}
              {{ t.vote_type }}
            {% endif %}
          </div>
          <div>{{ t.vote_length }}</div>
        </div>
        {% if t.comments and t.comments|length > 0 %}
        <div class="hidden md:block" style="padding: 0 16px 8px 16px;">
          <details class="mt-1 comments-block">
            <summary class="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded bg-slate-100 text-slate-700 border border-slate-200 cursor-pointer comments-toggle" onclick="event.stopPropagation()" title="Parsed from META 'comment' using #n: markers">{{ t.comments|length }} comment{{ 's' if t.comments|length != 1 else '' }}</summary>
            <ul class="mt-1.5 text-[11px] text-slate-700 space-y-0.5">
              {% set max_show = 3 %}
              {% for c in t.comments[:max_show] %}
              <li class="flex items-start gap-1"><span class="text-slate-400">‚Ä¢</span><span>{{ c }}</span></li>
              {% endfor %}
            </ul>
            {% if t.comments|length > max_show %}
            <details class="mt-1">
              <summary class="text-[11px] text-indigo-600 cursor-pointer" onclick="event.stopPropagation()">Show {{ t.comments|length - max_show }} more</summary>
              <ul class="mt-1 text-[11px] text-slate-700 space-y-1">
                {% for c in t.comments[max_show:] %}
                <li class="flex items-start gap-1"><span class="text-slate-400">‚Ä¢</span><span>{{ c }}</span></li>
                {% endfor %}
              </ul>
            </details>
            {% endif %}
          </details>
        </div>
        {% endif %}
      </section>
      {% endfor %}
      <div id="sentinel" class="sentinel" aria-hidden="true"></div>
    </form>
    <script src="{{ url_for('main.static', filename='app.js') }}"></script>
  </div>
    </div>
    {% include 'footer.html' %}
{% endblock %}

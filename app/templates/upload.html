{% extends 'base.html' %}

{% block title %}Upload & Check your PB file{% endblock %}

{% block body %}
<section class="max-w-5xl mx-auto px-4 py-8">
  <!-- Small banner: tool under active development -->
  <div class="mb-4 rounded-md border border-yellow-200 bg-yellow-50 text-yellow-900 px-3 py-2 text-sm">
    <strong>Heads up:</strong> this tool is in active development. Some parts may not work perfectly yet. Thanks for your patience — and if you run into issues, please let us know!
  </div>
  <h1 class="text-3xl font-bold text-slate-800 mb-4">Upload &amp; Check your PB file</h1>
  <div class="text-slate-700 mb-6 space-y-3">
    <div class="text-xs text-slate-500">
      Checker version: <span class="font-mono text-slate-700">{{ checker_version or 'not installed' }}</span>
    </div>
    <ol class="list-decimal pl-5 space-y-1">
      <li>Validate your <code>.pb</code> file to check for issues.</li>
      <li>If your file is valid, you can send it to our admins for acceptance. Approved files will be published on the site.</li>
    </ol>
    <p class="text-sm text-slate-600">We only use your email to contact you about your submission.</p>

    <p class="text-sm">
      Column order isn’t mandatory, but it’s strongly recommended and follows our PB data format. See
      <a href="https://pabulib.org/format" class="text-indigo-700 underline" target="_blank" rel="noopener">PB data format</a>
      and the
      <a href="https://github.com/pabulib/checker/blob/main/pabulib_helpers/fields.py" class="text-indigo-700 underline" target="_blank" rel="noopener">checker field order</a>.
    </p>

    <p>
  Our PB Checker is open source: 
  <a href="https://github.com/pabulib/checker" class="text-indigo-700 underline" target="_blank" rel="noopener">pabulib/checker</a>.
  We welcome contributions. If you spot a bug or have an improvement in mind, you can open an issue or submit a PR — or just share your thoughts via our email
  <a href="mailto:pabulib@uj.edu.pl" class="text-indigo-700 underline">pabulib@uj.edu.pl</a>.
    </p>
  </div>

  {% include 'partials/upload_how_it_works.html' %}

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <label class="block text-sm font-medium mb-1" for="email">Your email (required to submit)</label>
      <input id="email" type="email" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm" placeholder="you@example.org" />
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Limits</label>
      <div class="text-sm text-slate-600">Max file size: <strong>{{ (upload_settings.max_file_mb if upload_settings else 10) | int }}</strong> MB</div>
    </div>
  </div>

  <div id="dropzone" class="mt-6 border-2 border-dashed border-slate-300 rounded-md p-8 text-center cursor-pointer hover:bg-slate-50">
    <div class="text-slate-700">Drop .pb files here or click to select</div>
    <input id="files" type="file" accept=".pb" multiple class="hidden" />
  </div>

    <!-- Subtle legend (mirrors admin) -->
    <div class="text-xs text-slate-500 mt-4 mb-2 flex items-center gap-3">
      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-emerald-200 bg-emerald-100 text-emerald-800" title="Valid file">✓ Valid</span>
      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-red-200 bg-red-100 text-red-800" title="Invalid file">✗ Invalid</span>
      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-blue-200 bg-blue-50 text-blue-700" title="File will be uploaded as a new dataset">New</span>
      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-orange-200 bg-orange-50 text-orange-700" title="File will overwrite an existing dataset">Overwrite</span>
    </div>

  <!-- Progress bar (hidden by default) -->
  <div id="uploadProgress" class="hidden mt-4">
    <div class="bg-slate-100 rounded-full h-2.5 overflow-hidden">
      <div id="progressBar" class="bg-indigo-600 h-full transition-all duration-300 ease-out" style="width: 0%"></div>
    </div>
    <div class="mt-2 text-sm text-slate-600 text-center">
      <div class="flex items-center justify-center gap-2">
        <span id="progressPhase" class="px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700">Upload</span>
        <span id="progressText">Uploading files...</span>
        <span id="progressPercent" class="font-medium">0%</span>
      </div>
    </div>
    <div class="text-xs text-slate-500 text-center mt-2 space-y-1">
      <div id="progressFileCount" class="hidden">
        Processing file <span id="currentFileNum">1</span> of <span id="totalFileNum">1</span>
      </div>
      <div id="progressFileName" class="hidden font-mono text-slate-600 truncate max-w-md mx-auto" title=""></div>
      <div id="progressHint" class="text-slate-400">After upload completes, files will be validated. Please wait...</div>
    </div>
  </div>

  <!-- Toolbar for selection and submit/delete -->
  <div class="mt-4 flex items-start gap-4">
    <div class="flex items-center gap-3">
      <label class="inline-flex items-center gap-2 text-slate-700">
        <input id="selectAll" type="checkbox" class="w-4 h-4">
        <span>Select all</span>
      </label>
      <span id="countLabel" class="text-sm text-slate-500"></span>
    </div>
    <div class="ml-auto">
      <div class="flex gap-2">
        <button id="deleteSelected" type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">Delete selected</button>
        <button id="submitSelected" type="button" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">Send selected for acceptance</button>
      </div>
    </div>
  </div>

  <!-- Tiles list (mirrors admin layout, without admin-only actions) -->
  <div id="tiles" class="mt-6 space-y-4">
    {% for t in tiles or [] %}
      <section class="rounded-lg shadow p-4 tile-preview relative cursor-pointer hover:ring-4 transition-all {{ 'bg-emerald-50 ring-2 ring-emerald-200' if t.validation.valid else 'bg-red-50 ring-2 ring-red-200' }}"
        data-name="{{ t.file_name }}"
        data-valid="{{ 'true' if t.validation.valid else 'false' }}"
        onclick="toggleTileSelection(this, event)"
      >
        <div class="flex items-start gap-4">
          <input type="checkbox" class="tileChk mt-1.5" />
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-3">
              <h2 class="text-lg font-semibold text-slate-800 truncate" title="{{ t.title }}">{{ t.title }}</h2>
              {% if t.experimental %}
                <span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700">Experimental</span>
              {% endif %}
              {% if t.fully_funded %}
                <span class="text-xs px-2 py-0.5 rounded bg-emerald-100 text-emerald-700">Fully funded</span>
              {% endif %}
            </div>
            <div class="mt-1 flex items-center gap-2 flex-wrap">
              {% if t.exists_conflict %}
                <span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700 border border-orange-200">Overwrite</span>
              {% else %}
                <span class="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700 border border-blue-200">New</span>
              {% endif %}
            </div>
            <div class="text-slate-600 text-sm mt-1">{{ t.description }}</div>
            <div class="text-slate-500 text-xs mt-1 font-mono break-words">{{ t.file_name }}</div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mt-3 text-sm">
              <div class="text-slate-500"># votes<br><span class="text-slate-800">{{ t.num_votes }}</span></div>
              <div class="text-slate-500"># projects<br><span class="text-slate-800">{{ t.num_projects }}</span></div>
              <div class="text-slate-500">Budget<br><span class="text-slate-800">{{ t.budget }}</span></div>
              <div class="text-slate-500">Vote type<br><span class="text-slate-800">{{ t.vote_type }}</span></div>
              <div class="text-slate-500">Vote length<br><span class="text-slate-800">{{ t.vote_length }}</span></div>
            </div>
            {% if t.comments and t.comments|length > 0 %}
            <details class="mt-3 comments-block">
              <summary class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded bg-slate-100 text-slate-700 border border-slate-200 cursor-pointer comments-toggle" onclick="event.stopPropagation()" title="Parsed from META 'comment' using #n: markers">{{ t.comments|length }} comment{{ 's' if t.comments|length != 1 else '' }}</summary>
              <ul class="mt-2 text-xs text-slate-700 space-y-1">
                {% set max_show = 3 %}
                {% for c in t.comments[:max_show] %}
                <li class="flex items-start gap-1"><span class="text-slate-400">•</span><span>{{ c }}</span></li>
                {% endfor %}
              </ul>
              {% if t.comments|length > max_show %}
              <details class="mt-1">
                <summary class="text-xs text-indigo-600 cursor-pointer" onclick="event.stopPropagation()">Show {{ t.comments|length - max_show }} more</summary>
                <ul class="mt-1 text-xs text-slate-700 space-y-1">
                  {% for c in t.comments[max_show:] %}
                  <li class="flex items-start gap-1"><span class="text-slate-400">•</span><span>{{ c }}</span></li>
                  {% endfor %}
                </ul>
              </details>
              {% endif %}
            </details>
            {% endif %}
          </div>

          {% if t.validation %}
          <div class="w-64 shrink-0 border-l border-slate-200 pl-4">
            <div class="text-xs font-medium text-slate-600 mb-2" title="Results produced by the Checker">Validation Report (Checker)</div>
            <div class="flex items-start gap-2 mb-2">
              <span class="text-xl {{ 'text-emerald-600' if t.validation.valid else ('text-orange-600' if t.validation.error_message else 'text-red-600') }}">
                {{ '✓' if t.validation.valid else ('!' if t.validation.error_message else '✗') }}
              </span>
              <div class="flex-1 text-xs">
                {% if t.validation_summary %}
                  <div class="mb-1">{{ t.validation_summary }}</div>
                {% endif %}
                <div class="text-slate-600">Errors: <span class="font-medium">{{ t.error_count or 0 }}</span> • Warnings: <span class="font-medium">{{ t.warning_count or 0 }}</span></div>
              </div>
            </div>
            {% if t.validation.errors or t.validation.warnings %}
            <button type="button" class="text-xs text-indigo-600 hover:text-indigo-800 underline validation-toggle" data-target-id="validation-{{ t.file_name|e }}">Show details</button>
            <div id="validation-{{ t.file_name|e }}" class="hidden mt-2 p-2 bg-slate-50 rounded text-xs space-y-2 max-h-48 overflow-y-auto">
              {% if t.validation.errors %}
              <div>
                <div class="font-semibold text-red-700 mb-1">Errors:</div>
                <ul class="list-disc list-inside space-y-1 text-red-600">
                  {% for error_type, instances in t.validation.errors.items() %}
                    {% for instance_id, message in instances.items() %}
                      <li><span class="font-medium">{{ error_type }}:</span> {{ message }}</li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
              {% if t.validation.warnings %}
              <div>
                <div class="font-semibold text-orange-700 mb-1">Warnings:</div>
                <ul class="list-disc list-inside space-y-1 text-orange-600">
                  {% for warning_type, instances in t.validation.warnings.items() %}
                    {% for instance_id, message in instances.items() %}
                      <li><span class="font-medium">{{ warning_type }}:</span> {{ message }}</li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </section>
    {% endfor %}
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const filesInput = document.getElementById('files');
  const dz = document.getElementById('dropzone');
  const tiles = document.getElementById('tiles');
  const selectAll = document.getElementById('selectAll');
  const countLabel = document.getElementById('countLabel');
  const submitSelected = document.getElementById('submitSelected');
  const deleteSelected = document.getElementById('deleteSelected');
  const maxMb = parseInt('{{ (upload_settings.max_file_mb if upload_settings else 10) | int }}',10)||10;
  const maxBatch = parseInt('{{ (upload_settings.max_batch if upload_settings else 100) | int }}',10)||100;
  const MAX_SIZE = maxMb*1024*1024;
  var csrfMeta = document.querySelector('meta[name="csrf-token"]');
  const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
  // Progress UI refs
  const progressContainer = document.getElementById('uploadProgress');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const progressPercent = document.getElementById('progressPercent');
  const progressPhase = document.getElementById('progressPhase');
  const progressFileCount = document.getElementById('progressFileCount');
  const progressFileName = document.getElementById('progressFileName');
  const currentFileNum = document.getElementById('currentFileNum');
  const totalFileNum = document.getElementById('totalFileNum');
  const progressHint = document.getElementById('progressHint');

  function buildHeaders(extra){
    const h = { 'X-Requested-With': 'fetch' };
    if (csrfToken) h['X-CSRF-Token'] = csrfToken;
    return Object.assign(h, extra||{});
  }

  function pick(){
    if(!filesInput) return;
    try {
      if (typeof filesInput.showPicker === 'function') {
        filesInput.showPicker();
      } else {
        filesInput.click();
      }
    } catch (e) {
      // Fallback if showPicker is unsupported or throws
      try { filesInput.click(); } catch(_){}
    }
  }
  dz.addEventListener('click', pick);
  ;['dragenter','dragover'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dz.classList.add('ring','ring-indigo-500'); }));
  ;['dragleave','drop'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dz.classList.remove('ring','ring-indigo-500'); }));
  dz.addEventListener('drop', e=>{ const fs = Array.from(e.dataTransfer.files||[]); if(fs.length) upload(fs); });
  filesInput.addEventListener('change', e=>{ const fs = Array.from(filesInput.files||[]); if(fs.length) upload(fs); });

  function updateCount(){
    const allTiles = tiles.querySelectorAll('[data-name]');
    const checked = Array.from(tiles.querySelectorAll('.tileChk:checked'));
    const checkedValid = checked.filter(cb => {
      const tile = cb.closest('[data-name]');
      return tile && tile.getAttribute('data-valid') === 'true';
    });
    countLabel.textContent = `${checked.length}/${allTiles.length} selected (${checkedValid.length} valid)`;
    submitSelected.disabled = checkedValid.length===0;
    deleteSelected.disabled = checked.length===0;
  }

  selectAll.addEventListener('change', ()=>{
    tiles.querySelectorAll('.tileChk').forEach(cb=>{ cb.checked = selectAll.checked; });
    updateCount();
  });

  tiles.addEventListener('change', e=>{
    if(e.target && e.target.classList.contains('tileChk')){
      const all = tiles.querySelectorAll('.tileChk');
      const checked = tiles.querySelectorAll('.tileChk:checked');
      selectAll.checked = all.length>0 && checked.length===all.length;
      selectAll.indeterminate = checked.length>0 && checked.length<all.length;
      updateCount();
    }
  });

  async function upload(fs){
    if(fs.length>maxBatch){ alert(`Too many files. Max is ${maxBatch}.`); return; }
    const okFiles = [];
    const rejected = [];
    for(const f of fs){
      const n = (f.name||'').toLowerCase();
      if(!n.endsWith('.pb')){ rejected.push({name:f.name, reason:'Only .pb files are allowed'}); continue; }
      if(typeof f.size==='number' && f.size>MAX_SIZE){ rejected.push({name:f.name, reason:`File too large (> ${maxMb} MB)`}); continue; }
      okFiles.push(f);
    }
    if(rejected.length && !okFiles.length){
      alert(rejected.map(r=>`${r.name} — ${r.reason}`).join('\n'));
      return;
    }
  const fd = new FormData();
  okFiles.forEach(f=> fd.append('files', f));

    // Show progress bar
    if(progressContainer){
      progressContainer.classList.remove('hidden');
      if(progressBar) progressBar.style.width='0%';
      if(progressPercent) progressPercent.textContent='0%';
      if(progressText) progressText.textContent = `Uploading ${okFiles.length} file${okFiles.length===1?'':'s'}...`;
      if(progressPhase){
        progressPhase.textContent='Upload';
        progressPhase.className='px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700';
      }
      if(progressFileCount) progressFileCount.classList.add('hidden');
      if(progressFileName) progressFileName.classList.add('hidden');
      if(progressHint) progressHint.textContent = 'After upload completes, files will be validated. Please wait...';
    }

    // Use XHR to track progress
    const xhr = new XMLHttpRequest();
    const uploadPromise = new Promise((resolve,reject)=>{
      xhr.onload = ()=>{ if(xhr.status>=200 && xhr.status<300){ resolve(xhr); } else { reject(new Error('Upload failed')); } };
      xhr.onerror = ()=> reject(new Error('Upload failed'));
    });
    xhr.upload.addEventListener('progress', (e)=>{
      if(e.lengthComputable && progressBar && progressPercent){
        const pct = Math.round((e.loaded/e.total)*100);
        progressBar.style.width = pct+'%';
        progressPercent.textContent = pct+'%';
      }
    });
  xhr.open('POST', "{{ url_for('main.upload_upload_batch') }}", true);
  xhr.setRequestHeader('X-Requested-With','fetch');
  if(csrfToken){ try{ xhr.setRequestHeader('X-CSRF-Token', csrfToken); }catch(_e){} }
    xhr.send(fd);

    let data;
    try{
      const respX = await uploadPromise;
      try { data = JSON.parse(respX.responseText); } catch(_e){ data = { ok:false, error:'Invalid server response' }; }
    }catch(_e){
      if(progressContainer) progressContainer.classList.add('hidden');
      alert('Upload failed');
      return;
    }
    if(!data || !data.ok){
      if(progressContainer) progressContainer.classList.add('hidden');
      alert((data && data.error) || 'Upload failed');
      return;
    }
    // Handle duplicate-in-session case (same standardized name) like admin: prompt and retry with force_replace
    const rejectedDuplicates = (data.results||[]).filter(r=> r && r.ok===false && /Duplicate webpage_name/i.test(r.msg||''));
    if(rejectedDuplicates.length){
      if(progressContainer) progressContainer.classList.add('hidden');
      const names = rejectedDuplicates.map(r=> r.webpage_name || r.name).filter(Boolean);
      let confirmMsg = 'Some files were rejected because they have the same webpage_name as files already uploaded in this session.\n\n';
      if(names.length){ confirmMsg += 'Existing webpage_names:\n' + names.map(n=>'  • '+n).join('\n') + '\n\n'; }
      confirmMsg += 'Do you want to REPLACE the existing temp files with the new ones?';
      const proceed = confirm(confirmMsg);
      if(!proceed) return;

      // Re-show progress and re-upload with force_replace
      if(progressContainer){
        progressContainer.classList.remove('hidden');
        if(progressBar) progressBar.style.width='0%';
        if(progressPercent) progressPercent.textContent='0%';
        if(progressText) progressText.textContent=`Re-uploading ${okFiles.length} file${okFiles.length===1?'':'s'}...`;
        if(progressPhase){
          progressPhase.textContent='Re-upload';
          progressPhase.className='px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700';
        }
        if(progressHint) progressHint.textContent='Replacing existing files, then validating. Please wait...';
      }

      const fd2 = new FormData();
      okFiles.forEach(f=> fd2.append('files', f));
      fd2.append('force_replace','1');
      const xhr2 = new XMLHttpRequest();
      const reuploadPromise = new Promise((resolve,reject)=>{ xhr2.onload=()=>{ if(xhr2.status>=200 && xhr2.status<300) resolve(xhr2); else reject(new Error('Re-upload failed')); }; xhr2.onerror=()=>reject(new Error('Re-upload failed')); });
      xhr2.upload.addEventListener('progress', (e)=>{
        if(e.lengthComputable && progressBar && progressPercent){ const pct = Math.round((e.loaded/e.total)*100); progressBar.style.width=pct+'%'; progressPercent.textContent=pct+'%'; }
      });
      xhr2.open('POST', "{{ url_for('main.upload_upload_batch') }}", true);
      xhr2.setRequestHeader('X-Requested-With','fetch');
      if(csrfToken){ try{ xhr2.setRequestHeader('X-CSRF-Token', csrfToken); }catch(_e){} }
      xhr2.send(fd2);
      try { await reuploadPromise; } catch(_e){ if(progressContainer) progressContainer.classList.add('hidden'); alert('Re-upload failed'); return; }
      if(progressPhase){ progressPhase.textContent='Validation'; progressPhase.className='px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700'; }
      if(progressText) progressText.textContent='Preparing validation...';
      if(progressBar) progressBar.style.width='100%';
      if(progressPercent) progressPercent.textContent='100%';
      if(progressHint) progressHint.textContent='Upload complete. Refreshing list...';
      await new Promise(r=> setTimeout(r, 300));
      await refreshTiles();
      return;
    }
    // Alert if any uploaded file would overwrite an existing dataset (same webpage_name)
    try{
      const conflicts = (data.results||[]).filter(r=> r && r.ok && r.exists_conflict);
      if(conflicts.length){
        const list = conflicts.map(c=>` • ${c.webpage_name || c.name}`).join('\n');
        alert(`Heads up: some uploads match an existing dataset (same webpage_name) and would overwrite if accepted by admins:\n\n${list}`);
      }
    }catch(_e){}
    // Transition to validation UI state (public page re-runs server-side validations on refresh)
    if(progressPhase){
      progressPhase.textContent='Validation';
      progressPhase.className='px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700';
    }
    if(progressText) progressText.textContent='Preparing validation...';
    if(progressBar) progressBar.style.width='100%';
    if(progressPercent) progressPercent.textContent='100%';
    if(progressHint) progressHint.textContent='Upload complete. Refreshing list...';
    await new Promise(r=> setTimeout(r, 300));
    await refreshTiles();
  }

  async function refreshTiles(){
      const html = await fetch(window.location.href, {headers: buildHeaders(), credentials: 'same-origin'}).then(r=>r.text()).catch(()=>null);
    if(!html) return;
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const newTiles = doc.querySelector('#tiles');
    if(newTiles){ tiles.innerHTML = newTiles.innerHTML; bindInitial(); }
  }

  // Delegate clicks for toggling validation details to avoid inline JS and ensure safe handling
  tiles.addEventListener('click', (e)=>{
    const btn = e.target.closest('.validation-toggle');
    if(!btn || !tiles.contains(btn)) return;
    const targetId = btn.getAttribute('data-target-id');
    if(!targetId) return;
    const detailsEl = document.getElementById(targetId);
    if(detailsEl){ detailsEl.classList.toggle('hidden'); }
  });

  // Make tiles clickable to toggle selection like in admin
  window.toggleTileSelection = function(tile, event){
    // Avoid toggling when clicking on interactive elements
    const target = event.target;
    if (!target) return;
    if (target.tagName === 'BUTTON' || target.tagName === 'A' || target.tagName === 'INPUT' ||
        target.closest('button') || target.closest('a') || target.closest('form') ||
        target.classList.contains('validation-toggle')) {
      return;
    }
    const cb = tile.querySelector('.tileChk');
    if(cb){
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event('change', { bubbles: true }));
    }
  };

  function bindInitial(){
    updateCount();
  }

  submitSelected.addEventListener('click', async ()=>{
    const email = (document.getElementById('email').value||'').trim();
    if(!email){ alert('Please enter your email to proceed.'); return; }
    const selValid = Array.from(tiles.querySelectorAll('.tileChk:checked'))
      .map(cb=> cb.closest('[data-name]'))
      .filter(tile=> tile && tile.getAttribute('data-valid')==='true')
      .map(tile=> tile.getAttribute('data-name'));
    if(selValid.length===0){ alert('Please select at least one valid file to submit.'); return; }
    submitSelected.disabled = true;
    const resp = await fetch("{{ url_for('main.upload_submit_selected') }}", { method:'POST', headers: buildHeaders({'Content-Type':'application/json'}), credentials: 'same-origin', body: JSON.stringify({ email, files: selValid }) });
    const data = await resp.json().catch(()=>({ok:false,error:'Invalid server response'}));
    if(data.ok){ alert(`Submitted ${data.saved} valid file(s) for acceptance.`); await refreshTiles(); }
    else { alert(data.error||'Submit failed'); }
    submitSelected.disabled = false;
  });

  deleteSelected.addEventListener('click', async ()=>{
    const sel = Array.from(tiles.querySelectorAll('.tileChk:checked')).map(cb=> cb.closest('[data-name]').getAttribute('data-name'));
    if(sel.length===0){ alert('Please select files to delete.'); return; }
    if(!confirm(`Delete ${sel.length} selected file(s) from this session?`)) return;
    deleteSelected.disabled = true;
    const resp = await fetch("{{ url_for('main.upload_delete_selected') }}", { method:'POST', headers: buildHeaders({'Content-Type':'application/json'}), credentials: 'same-origin', body: JSON.stringify({ files: sel }) });
    const data = await resp.json().catch(()=>({ok:false,error:'Invalid server response'}));
    if(data.ok){ alert(`Deleted ${data.deleted} file(s).`); await refreshTiles(); }
    else { alert(data.error||'Delete failed'); }
    deleteSelected.disabled = false;
  });

  bindInitial();
})();
</script>
{% endblock %}

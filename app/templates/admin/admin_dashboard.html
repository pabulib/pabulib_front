{% extends 'base.html' %}

{% block bodyClass %}admin{% endblock %}
{% block title %}Admin Dashboard{% endblock %}

{% block body %}
{% include 'admin/_navbar.html' %}
<section class="max-w-7xl mx-auto px-4">
  <div class="flex gap-6 justify-center">
    <!-- Sidebar filters (left) -->
    <aside class="hidden md:block w-64 shrink-0 mt-8">
      <div class="bg-white rounded-lg shadow-lg p-5 sticky top-24">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">Filters</h2>

        <div class="mb-4">
          <label for="filterYear" class="block text-sm font-medium text-slate-700 mb-1">Year</label>
          <select id="filterYear" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-800 focus:ring-2 focus:ring-indigo-500">
            <option value="">All years</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="filterCountry" class="block text-sm font-medium text-slate-700 mb-1">Country</label>
          <select id="filterCountry" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-800 focus:ring-2 focus:ring-indigo-500">
            <option value="">All countries</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="filterCity" class="block text-sm font-medium text-slate-700 mb-1">City</label>
          <select id="filterCity" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-800 focus:ring-2 focus:ring-indigo-500">
            <option value="">All cities</option>
          </select>
        </div>

        <div class="mb-2">
          <label for="filterType" class="block text-sm font-medium text-slate-700 mb-1">Vote type</label>
          <select id="filterType" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-800 focus:ring-2 focus:ring-indigo-500">
            <option value="">Any type</option>
            <option value="approval">Approval</option>
            <option value="cumulative">Cumulative</option>
            <option value="ranked">Ranked</option>
            <option value="k-approval">K-approval</option>
            <option value="unknown">Unknown</option>
          </select>
        </div>

        <button id="filtersClear" type="button" class="mt-4 w-full px-3 py-2 text-sm rounded-md border border-slate-300 text-slate-600 hover:bg-slate-50">Clear filters</button>
      </div>
    </aside>

    <div class="w-full bg-white rounded-lg shadow-lg p-8 mt-8">
      <div class="flex items-baseline justify-between mb-6">
        <h1 class="text-3xl font-bold text-slate-800">Admin – Active Files</h1>
        <span class="text-sm text-slate-500">{{ count }} current files</span>
      </div>
  <p class="text-gray-600 mb-6">Tip: search filters by title only (years ignored). Click a column header to sort by File, File mtime, or Ingested.</p>

      <!-- Toolbar: search + bulk actions -->
      <div class="mb-4 flex items-center gap-3">
        <div class="relative w-full max-w-md">
          <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 4.238 12.03l4.241 4.241a.75.75 0 1 0 1.06-1.06l-4.24-4.242A6.75 6.75 0 0 0 10.5 3.75Zm-5.25 6.75a5.25 5.25 0 1 1 10.5 0 5.25 5.25 0 0 1-10.5 0Z" clip-rule="evenodd"/></svg>
          </span>
          <input id="adminSearch" type="text" placeholder="Search titles…" class="w-full pl-10 pr-10 py-2.5 rounded-md border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-800 placeholder-slate-400" />
          <button id="adminSearchClear" type="button" class="hidden absolute inset-y-0 right-0 pr-3 text-slate-400 hover:text-slate-600" aria-label="Clear search">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12 2.25a9.75 9.75 0 1 0 0 19.5 9.75 9.75 0 0 0 0-19.5Zm-2.47 6.78a.75.75 0 0 1 1.06 0L12 10.44l1.41-1.41a.75.75 0 0 1 1.06 1.06L13.06 11.5l1.41 1.41a.75.75 0 1 1-1.06 1.06L12 12.56l-1.41 1.41a.75.75 0 0 1-1.06-1.06l1.41-1.41-1.41-1.41a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd"/></svg>
          </button>
        </div>
        <span id="adminCount" class="text-sm text-slate-500 whitespace-nowrap"></span>
        <div class="ml-auto flex items-center gap-2">
          <label class="inline-flex items-center gap-2 text-slate-700">
            <input id="adminSelectAll" type="checkbox" class="w-4 h-4">
            <span>Select all</span>
          </label>
          <button id="adminDeleteSelected" type="button" class="px-3 py-2 rounded-md border border-red-300 text-red-700 hover:bg-red-50">Delete selected</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="adminTable" class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">
                <button type="button" class="sort-btn inline-flex items-center gap-1 select-none" data-key="file" data-type="string" aria-label="Sort by file">
                  <span>File</span>
                  <span class="sort-icons inline-flex text-slate-400">
                    <!-- neutral -->
                    <svg class="icon-neutral w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4a1 1 0 0 1 .707.293l3 3a1 1 0 1 1-1.414 1.414L8 7.414V19a1 1 0 1 1-2 0V7.414L4.707 8.707A1 1 0 1 1 3.293 7.293l3-3A1 1 0 0 1 7 4Zm10 16a1 1 0 0 0 .707-.293l3-3a1 1 0 1 0-1.414-1.414L20 16.586V5a1 1 0 1 0-2 0v11.586l-1.293-1.293a1 1 0 1 0-1.414 1.414l3 3A1 1 0 0 0 17 20Z"/></svg>
                    <!-- asc -->
                    <svg class="icon-asc w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4a1 1 0 0 1 .707.293l3 3a1 1 0 1 1-1.414 1.414L8 7.414V19a1 1 0 1 1-2 0V7.414L4.707 8.707A1 1 0 1 1 3.293 7.293l3-3A1 1 0 0 1 7 4Z"/></svg>
                    <!-- desc -->
                    <svg class="icon-desc w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 20a1 1 0 0 1-.707-.293l-3-3a1 1 0 1 1 1.414-1.414L16 16.586V5a1 1 0 1 1 2 0v11.586l1.293-1.293a1 1 0 1 1 1.414 1.414l-3 3A1 1 0 0 1 17 20Z"/></svg>
                  </span>
                </button>
              </th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">
                <button type="button" class="sort-btn inline-flex items-center gap-1 select-none" data-key="mtime" data-type="date" aria-label="Sort by file modification time">
                  <span>File mtime</span>
                  <span class="sort-icons inline-flex text-slate-400">
                    <svg class="icon-neutral w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4a1 1 0 0 1 .707.293l3 3a1 1 0 1 1-1.414 1.414L8 7.414V19a1 1 0 1 1-2 0V7.414L4.707 8.707A1 1 0 1 1 3.293 7.293l3-3A1 1 0 0 1 7 4Zm10 16a1 1 0 0 0 .707-.293l3-3a1 1 0 1 0-1.414-1.414L20 16.586V5a1 1 0 1 0-2 0v11.586l-1.293-1.293a1 1 0 1 0-1.414 1.414l3 3A1 1 0 0 0 17 20Z"/></svg>
                    <svg class="icon-asc w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4a1 1 0 0 1 .707.293l3 3a1 1 0 1 1-1.414 1.414L8 7.414V19a1 1 0 1 1-2 0V7.414L4.707 8.707A1 1 0 1 1 3.293 7.293l3-3A1 1 0 0 1 7 4Z"/></svg>
                    <svg class="icon-desc w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 20a1 1 0 0 1-.707-.293l-3-3a1 1 0 1 1 1.414-1.414L16 16.586V5a1 1 0 1 1 2 0v11.586l1.293-1.293a1 1 0 1 1 1.414 1.414l-3 3A1 1 0 0 1 17 20Z"/></svg>
                  </span>
                </button>
              </th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 border-b border-gray-200">
                <button type="button" class="sort-btn inline-flex items-center gap-1 select-none" data-key="ingested" data-type="date" aria-label="Sort by ingested time">
                  <span>Ingested</span>
                  <span class="sort-icons inline-flex text-slate-400">
                    <svg class="icon-neutral w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4a1 1 0 0 1 .707.293l3 3a1 1 0 1 1-1.414 1.414L8 7.414V19a1 1 0 1 1-2 0V7.414L4.707 8.707A1 1 0 1 1 3.293 7.293l3-3A1 1 0 0 1 7 4Zm10 16a1 1 0 0 0 .707-.293l3-3a1 1 0 1 0-1.414-1.414L20 16.586V5a1 1 0 1 0-2 0v11.586l-1.293-1.293a1 1 0 1 0-1.414 1.414l3 3A1 1 0 0 0 17 20Z"/></svg>
                    <svg class="icon-asc w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 4a1 1 0 0 1 .707.293l3 3a1 1 0 1 1-1.414 1.414L8 7.414V19a1 1 0 1 1-2 0V7.414L4.707 8.707A1 1 0 1 1 3.293 7.293l3-3A1 1 0 0 1 7 4Z"/></svg>
                    <svg class="icon-desc w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 20a1 1 0 0 1-.707-.293l-3-3a1 1 0 1 1 1.414-1.414L16 16.586V5a1 1 0 1 1 2 0v11.586l1.293-1.293a1 1 0 1 1 1.414 1.414l-3 3A1 1 0 0 1 17 20Z"/></svg>
                  </span>
                </button>
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for f in files %}
      <tr class="hover:bg-gray-50 admin-row"
        data-file="{{ f.file_name|e }}"
        data-title="{{ f.file_name|e }}"
                data-year="{{ f.year if f.year is not none else '' }}"
                data-country="{{ f.country|e if f.country else '' }}"
                data-city="{{ f.unit|e if f.unit else '' }}"
                data-type="{{ (f.vote_type|lower) if f.vote_type else 'unknown' }}"
                data-mtime="{{ f.file_mtime.strftime('%Y-%m-%d %H:%M:%S') if f.file_mtime else '' }}"
                data-ingested="{{ f.ingested_at.strftime('%Y-%m-%d %H:%M:%S') if f.ingested_at else '' }}">
              <td class="px-6 py-3 text-sm font-mono text-slate-800">
                <input class="mr-3 align-middle admin-row-check" type="checkbox" data-file="{{ f.file_name|e }}" />
                <span class="inline-block truncate max-w-[420px] align-middle" title="{{ f.file_name }}">{{ f.file_name }}</span>
              </td>
              <td class="px-6 py-3 text-sm text-slate-700 whitespace-nowrap">
                {{ f.file_mtime.strftime('%Y-%m-%d %H:%M:%S') if f.file_mtime else '—' }}
              </td>
              <td class="px-6 py-3 text-sm text-slate-700 whitespace-nowrap">
                {{ f.ingested_at.strftime('%Y-%m-%d %H:%M:%S') if f.ingested_at else '—' }}
              </td>
            </tr>
            {% endfor %}
            <tr id="noResultsRow" class="hidden">
              <td colspan="3" class="px-6 py-6 text-center text-sm text-slate-500">No files match your search.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const input = document.getElementById('adminSearch');
  const clearBtn = document.getElementById('adminSearchClear');
  const rows = Array.from(document.querySelectorAll('#adminTable .admin-row'));
  const noResults = document.getElementById('noResultsRow');
  const countEl = document.getElementById('adminCount');
  const total = rows.length;

  // Filter controls
  const selYear = document.getElementById('filterYear');
  const selCountry = document.getElementById('filterCountry');
  const selCity = document.getElementById('filterCity');
  const selType = document.getElementById('filterType');
  const btnClear = document.getElementById('filtersClear');

  function updateCount(visible){
    if(countEl){ countEl.textContent = `${visible} / ${total}`; }
  }

  function normalizeTitle(s){
    // Remove standalone 4-digit years (1900-2099) and collapse separators/whitespace
    return (s || '')
      .replace(/(?:^|[\s_\-\.\(\)\[\]])(19|20)\d{2}(?=$|[\s_\-\.\(\)\[\]])/g, ' ')
      .replace(/[\s_\-\.]+/g, ' ')
      .trim();
  }

  function filter(q){
    const terms = q.toLowerCase().split(/\s+/).filter(Boolean);
    const fy = (selYear && selYear.value)||'';
    const fc = ((selCountry && selCountry.value)||'').toLowerCase();
    const fcity = ((selCity && selCity.value)||'').toLowerCase();
    const ft = ((selType && selType.value)||'').toLowerCase();
    let visible = 0;
    rows.forEach(tr => {
      const title = normalizeTitle(tr.dataset.title || tr.dataset.file || '').toLowerCase();
      const year = (tr.dataset.year || '');
      const country = (tr.dataset.country || '').toLowerCase();
      const city = (tr.dataset.city || '').toLowerCase();
      const type = (tr.dataset.type || '').toLowerCase();
      // Title-only search (no dates)
      const matchesText = terms.every(t => title.includes(t));
      const matchesYear = !fy || year === fy;
      const matchesCountry = !fc || country === fc;
      const matchesCity = !fcity || city === fcity;
      const matchesType = !ft || type === ft;
      const matches = matchesText && matchesYear && matchesCountry && matchesCity && matchesType;
      tr.style.display = matches ? '' : 'none';
      if(matches) visible++;
    });
    if(noResults){ noResults.classList.toggle('hidden', visible !== 0); }
    updateCount(visible);
  }

  function onInput(){
    const val = input.value || '';
    clearBtn.classList.toggle('hidden', val.length === 0);
    filter(val);
  }

  // Initial state
  updateCount(total);
  filter('');

  let tid = null;
  input.addEventListener('input', function(){
    if(tid) cancelAnimationFrame(tid);
    const self = this;
    tid = requestAnimationFrame(() => onInput.call(self));
  });
  clearBtn.addEventListener('click', () => { input.value = ''; onInput(); input.focus(); });

  function populateSelect(selectEl, values, labeler){
    if(!selectEl) return;
    const unique = Array.from(new Set(values.filter(v => v !== '' && v !== null && v !== undefined)));
    // Sort numerically for years, otherwise alphabetically
    if(selectEl.id === 'filterYear'){
      unique.sort((a,b)=>parseInt(b,10)-parseInt(a,10));
    } else {
      unique.sort((a,b)=>String(a).localeCompare(String(b)));
    }
    unique.forEach(v => {
      const opt = document.createElement('option');
      opt.value = String(v);
      opt.textContent = labeler ? labeler(v) : String(v);
      selectEl.appendChild(opt);
    });
  }

  // Gather values from rows
  populateSelect(selYear, rows.map(tr => tr.dataset.year), v=>v);
  populateSelect(selCountry, rows.map(tr => tr.dataset.country));
  populateSelect(selCity, rows.map(tr => tr.dataset.city));

  // React to filter changes
  function updateSelectStates(){
    const vYear = (selYear && selYear.value) || '';
    const vCountry = ((selCountry && selCountry.value) || '').toLowerCase();
    const vCity = ((selCity && selCity.value) || '').toLowerCase();
    const vType = ((selType && selType.value) || '').toLowerCase();

    function eligibleRows(exclude){
      return rows.filter(tr => {
        const year = (tr.dataset.year || '');
        const country = (tr.dataset.country || '').toLowerCase();
        const city = (tr.dataset.city || '').toLowerCase();
        const type = (tr.dataset.type || '').toLowerCase();
        if(exclude !== 'year' && vYear && year !== vYear) return false;
        if(exclude !== 'country' && vCountry && country !== vCountry) return false;
        if(exclude !== 'city' && vCity && city !== vCity) return false;
        if(exclude !== 'type' && vType && type !== vType) return false;
        return true;
      });
    }

    function disableOptions(selectEl, key){
      if(!selectEl) return;
      const allowed = new Set(eligibleRows(key).map(tr => {
        if(key==='year') return tr.dataset.year || '';
        if(key==='country') return (tr.dataset.country || '').toLowerCase();
        if(key==='city') return (tr.dataset.city || '').toLowerCase();
        if(key==='type') return (tr.dataset.type || '').toLowerCase();
        return '';
      }).filter(Boolean));
      Array.from(selectEl.options).forEach(opt => {
        if(opt.value === '') { opt.disabled = false; return; }
        const val = (key==='year') ? opt.value : opt.value.toLowerCase();
        opt.disabled = !allowed.has(val);
      });
    }

    disableOptions(selYear, 'year');
    disableOptions(selCountry, 'country');
    disableOptions(selCity, 'city');
    disableOptions(selType, 'type');
  }

  [selYear, selCountry, selCity, selType].forEach(el => {
    if(!el) return;
    el.addEventListener('change', () => { updateSelectStates(); filter(input.value||''); });
  });

  if(btnClear){
    btnClear.addEventListener('click', () => {
      if(selYear) selYear.value = '';
      if(selCountry) selCountry.value = '';
      if(selCity) selCity.value = '';
      if(selType) selType.value = '';
      updateSelectStates();
      filter(input.value||'');
    });
  }

  // Sorting
  const tbody = document.querySelector('#adminTable tbody');
  const sortButtons = Array.from(document.querySelectorAll('.sort-btn'));
  let sortState = { key: null, dir: 'desc' }; // default dir when clicking first time
  const selAll = document.getElementById('adminSelectAll');
  const btnDelSel = document.getElementById('adminDeleteSelected');

  function parseDate(s){
    if(!s) return 0;
    const dt = new Date(s.replace(' ', 'T'));
    return isNaN(dt.getTime()) ? 0 : dt.getTime();
    }

  function compare(a,b,key,type,dir){
    let va, vb;
    if(type === 'date'){
      va = parseDate(a.dataset[key]);
      vb = parseDate(b.dataset[key]);
    } else { // string: use title for file
      va = key === 'file' ? (a.dataset.file||'').toLowerCase() : (a.dataset[key]||'').toLowerCase();
      vb = key === 'file' ? (b.dataset.file||'').toLowerCase() : (b.dataset[key]||'').toLowerCase();
    }
    if(va < vb) return dir === 'asc' ? -1 : 1;
    if(va > vb) return dir === 'asc' ? 1 : -1;
    // tie-breaker by file name to be stable
    const fa = (a.dataset.file||'').toLowerCase();
    const fb = (b.dataset.file||'').toLowerCase();
    if(fa < fb) return -1;
    if(fa > fb) return 1;
    return 0;
  }

  function updateIcons(){
    sortButtons.forEach(btn => {
      const icons = btn.querySelector('.sort-icons');
      const iconNeutral = icons.querySelector('.icon-neutral');
      const iconAsc = icons.querySelector('.icon-asc');
      const iconDesc = icons.querySelector('.icon-desc');
      if(btn.dataset.key === sortState.key){
        iconNeutral.classList.add('hidden');
        iconAsc.classList.toggle('hidden', sortState.dir !== 'asc');
        iconDesc.classList.toggle('hidden', sortState.dir !== 'desc');
      } else {
        iconNeutral.classList.remove('hidden');
        iconAsc.classList.add('hidden');
        iconDesc.classList.add('hidden');
      }
    });
  }

  function applySort(key,type){
    const dir = (sortState.key === key && sortState.dir === 'desc') ? 'asc' : 'desc';
    sortState = { key, dir };
    const visibleRows = rows.filter(tr => tr.style.display !== 'none');
    const hiddenRows = rows.filter(tr => tr.style.display === 'none');
    visibleRows.sort((a,b)=>compare(a,b,key,type,dir));
    // Re-append in new order: keep hidden rows at the end in their current order
    const frag = document.createDocumentFragment();
    visibleRows.forEach(tr => frag.appendChild(tr));
    hiddenRows.forEach(tr => frag.appendChild(tr));
    tbody.insertBefore(frag, noResults);
    updateIcons();
  }

  sortButtons.forEach(btn => {
    btn.addEventListener('click', () => applySort(btn.dataset.key, btn.dataset.type));
  });

  // Initialize select disabled states once options are populated
  updateSelectStates();

  function visibleRows(){ return rows.filter(tr => tr.style.display !== 'none'); }
  function checked(){ return Array.from(document.querySelectorAll('.admin-row-check')).filter(cb => cb.checked && cb.closest('tr').style.display !== 'none'); }
  if(selAll){ selAll.addEventListener('change', ()=>{ visibleRows().forEach(tr => { const cb = tr.querySelector('.admin-row-check'); if(cb) cb.checked = selAll.checked; }); }); }

  async function deleteNames(names){
    if(!names.length){ alert('No files selected'); return; }
    const n = names.length;
    const plural = n === 1 ? '' : 's';
    const msg = `Delete selected ${n} file${plural}? They will be archived and marked not current.`;
    if(!confirm(msg)) return;
    try{
      const resp = await fetch("{{ url_for('admin.admin_delete_files_bulk') }}", { method:'POST', headers:{'Content-Type':'application/json','X-Requested-With':'fetch'}, body: JSON.stringify({ names }) });
      if(!resp.ok){ const data = await resp.json().catch(()=>({})); alert('Delete failed: '+(data.error||resp.status)); return; }
      const data = await resp.json();
      window.location.href = "{{ url_for('admin.admin_dashboard') }}?message="+encodeURIComponent(`Deleted ${data.deleted||names.length} file(s).`)+"&success=1";
    }catch(e){ alert('Delete failed'); }
  }
  if(btnDelSel){ btnDelSel.addEventListener('click', ()=>{ const names = checked().map(cb => cb.dataset.file); deleteNames(names); }); }
})();
</script>
{% endblock %}

{% extends 'base.html' %}

{% block bodyClass %}admin{% endblock %}
{% block title %}Upload Tiles{% endblock %}

{% block body %}
{% include 'admin/_navbar.html' %}
<section class="max-w-5xl mx-auto px-4">
  <div class="w-full bg-white rounded-lg shadow-lg p-6 mt-8">
    <div class="flex items-baseline justify-between mb-4">
      <h1 class="text-3xl font-bold text-slate-800">Admin â€“ Upload Tiles</h1>
      <span class="text-sm text-slate-500">{{ count or 0 }} PB files</span>
    </div>
    <p class="text-gray-600 mb-6">These are temporary uploads. You can ingest them as new files or remove them from the temporary area.</p>

    <!-- Toolbar: search + bulk actions (mirrors admin dashboard style) -->
    <div class="mb-4 flex items-start gap-6">
      <!-- Left group: search + x/x + select all -->
      <div class="flex items-center gap-4 flex-1 min-w-0">
        <div class="relative w-full max-w-sm">
        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 4.238 12.03l4.241 4.241a.75.75 0 1 0 1.06-1.06l-4.24-4.242A6.75 6.75 0 0 0 10.5 3.75Zm-5.25 6.75a5.25 5.25 0 1 1 10.5 0 5.25 5.25 0 0 1-10.5 0Z" clip-rule="evenodd"/></svg>
        </span>
        <input id="tmpSearch" type="text" placeholder="Search titlesâ€¦" class="w-full pl-10 pr-10 py-2.5 rounded-md border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-800 placeholder-slate-400" />
        <button id="tmpSearchClear" type="button" class="hidden absolute inset-y-0 right-0 pr-3 text-slate-400 hover:text-slate-600" aria-label="Clear search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12 2.25a9.75 9.75 0 1 0 0 19.5 9.75 9.75 0 0 0 0-19.5Zm-2.47 6.78a.75.75 0 0 1 1.06 0L12 10.44l1.41-1.41a.75.75 0 0 1 1.06 1.06L13.06 11.5l1.41 1.41a.75.75 0 1 1-1.06 1.06L12 12.56l-1.41 1.41a.75.75 0 0 1-1.06-1.06l1.41-1.41-1.41-1.41a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd"/></svg>
        </button>
      </div>
        <span id="tmpCount" class="text-sm text-slate-500 whitespace-nowrap"></span>
        <label class="inline-flex items-center gap-2 text-slate-700">
          <input id="tmpSelectAll" type="checkbox" class="w-4 h-4">
          <span>Select all</span>
        </label>
      </div>

      <!-- Right group: selected label (left) + stacked actions (right) -->
      <div class="shrink-0 flex items-start gap-3">
        <span id="tmpSelectedLabel" class="mt-2 text-sm text-slate-600 whitespace-nowrap">Selected: <span id="tmpSelected">0</span></span>
        <div class="flex flex-col items-end gap-2">
          <button id="uploadSelectedBtn" type="button" class="w-48 px-3 py-2 rounded-md bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed">Upload</button>
          <button type="button" id="downloadSelected" class="w-48 px-3 py-2 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Download</button>
          <button type="button" id="deleteSelected" class="w-48 px-3 py-2 rounded-md border border-red-300 text-red-700 hover:bg-red-50 disabled:opacity-50 disabled:cursor-not-allowed">Delete</button>
        </div>
      </div>
    </div>

      {% if message %}
      <div class="p-3 rounded-md text-sm {{ 'bg-green-50 text-green-700 border border-green-200' if success else 'bg-red-50 text-red-700 border border-red-200' }}">
        {{ message }}
      </div>
      {% endif %}

      <div id="dropzone" class="border-2 border-dashed border-slate-300 rounded-md p-8 text-center text-slate-500 hover:border-slate-400 cursor-pointer">
        <div class="text-lg font-medium mb-1">Add files</div>
        <div class="text-sm">Drag & drop .pb files here, or click to choose</div>
        <input id="files" name="files" type="file" accept=".pb" multiple class="hidden" />
      </div>
    </div>
  </div>

  <div class="mt-6 space-y-4" id="tilesContainer">
    {% for t in tiles %}
    <section class="bg-white rounded-lg shadow p-4 tile-preview"
      data-title="{{ t.title|e }}"
      data-desc="{{ t.description|e }}"
      data-file="{{ t.file_name|e }}"
      data-exists="{{ '1' if t.exists_conflict else '' }}"
    >
      <div class="flex items-start gap-3">
        <input class="row-check mt-1.5" type="checkbox" data-file="{{ t.file_name|e }}" />
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-slate-800 truncate">{{ t.title }}</h2>
            {% if t.experimental %}
              <span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700">Experimental</span>
            {% endif %}
            {% if t.fully_funded %}
              <span class="text-xs px-2 py-0.5 rounded bg-emerald-100 text-emerald-700">Fully funded</span>
            {% endif %}
          </div>
          <div class="text-slate-600 text-sm mt-1">{{ t.description }}</div>
          <div class="grid grid-cols-6 gap-3 mt-3 text-sm">
            <div class="text-slate-500"># votes<br><span class="text-slate-800">{{ t.num_votes }}</span></div>
            <div class="text-slate-500"># projects<br><span class="text-slate-800">{{ t.num_projects }}</span></div>
            <div class="text-slate-500">Budget<br><span class="text-slate-800">{{ t.budget }}</span></div>
            <div class="text-slate-500">Vote type<br><span class="text-slate-800">{{ t.vote_type }}</span></div>
            <div class="text-slate-500">Vote length<br><span class="text-slate-800">{{ t.vote_length }}</span></div>
            <div class="text-slate-500">File<br><span class="text-slate-800 font-mono truncate block" title="{{ t.file_name }}">{{ t.file_name }}</span></div>
          </div>
        </div>
        <div class="flex flex-col items-center gap-2 ml-2">
          <a class="p-2 rounded-md border border-slate-300 hover:bg-slate-50" title="Download" href="{{ url_for('admin.upload_tiles_download', name=t.file_name) }}">â¬‡</a>
          <div class="flex flex-col items-center gap-1">
            <button class="p-2 rounded-md border border-slate-300 hover:bg-slate-50 ingest-one" data-file="{{ t.file_name|e }}" title="Ingest" type="button">â¤´</button>
            {% if t.exists_conflict %}
              <span class="text-[10px] text-orange-600" title="A current dataset exists; ingest will overwrite.">overwrite</span>
            {% endif %}
          </div>
          <form method="post" action="{{ url_for('admin.upload_tiles_delete') }}" onsubmit="return confirm('Delete this temp file?')">
            <input type="hidden" name="name" value="{{ t.file_name }}" />
            <button class="p-2 rounded-md border border-slate-300 hover:bg-slate-50 text-red-700" title="Delete" type="submit">ðŸ—‘</button>
          </form>
        </div>
      </div>
    </section>
    {% endfor %}
    {% if not tiles or tiles|length == 0 %}
      <div class="text-center text-slate-500">No temporary uploads yet.</div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('files');
  const tiles = Array.from(document.querySelectorAll('.tile-preview'));
  const countEl = document.getElementById('tmpCount');
  const selectAll = document.getElementById('tmpSelectAll');
  const search = document.getElementById('tmpSearch');
  const searchClear = document.getElementById('tmpSearchClear');
  const uploadSelectedBtn = document.getElementById('uploadSelectedBtn');
  const deleteSelected = document.getElementById('deleteSelected');
  const downloadSelected = document.getElementById('downloadSelected');
  const selectedCountEl = document.getElementById('tmpSelected');
  const selectedLabel = document.getElementById('tmpSelectedLabel');
  // const replaceWithSelected = document.getElementById('replaceWithSelected');
  const total = tiles.length;

  function updateCount(){
    const visible = tiles.filter(t => t.style.display !== 'none').length;
    if(countEl) countEl.textContent = `${visible} / ${total}`;
  }

  function filter(){
    const q = (search.value || '').toLowerCase().trim();
    tiles.forEach(t => {
      const title = (t.dataset.title || '').toLowerCase();
      const desc = (t.dataset.desc || '').toLowerCase();
      const file = (t.dataset.file || '').toLowerCase();
      const match = !q || title.includes(q) || desc.includes(q) || file.includes(q);
      t.style.display = match ? '' : 'none';
    });
    updateCount();
  }

  function checkedBoxes(){
    return Array.from(document.querySelectorAll('.row-check')).filter(cb => cb.checked && cb.closest('.tile-preview').style.display !== 'none');
  }

  if(search){
    let tid=null; search.addEventListener('input', ()=>{ if(tid) cancelAnimationFrame(tid); tid=requestAnimationFrame(()=>{ filter(); const has= (search.value||'').length>0; if(searchClear) searchClear.classList.toggle('hidden', !has); }); });
  }
  if(searchClear){
    searchClear.addEventListener('click', ()=>{ search.value=''; filter(); search.focus(); searchClear.classList.add('hidden'); });
  }
  if(selectAll){
    selectAll.addEventListener('change', ()=>{
      tiles.forEach(t => { if(t.style.display !== 'none'){ const cb=t.querySelector('.row-check'); if(cb) cb.checked = selectAll.checked; }});
      updateUploadSelectedButton();
    });
  }

  // Dropzone
  function highlight(on){ dropzone.classList.toggle('ring-2', on); dropzone.classList.toggle('ring-indigo-500', on); }
  ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); highlight(true);}));
  ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); highlight(false);}));
  dropzone.addEventListener('click', ()=> fileInput && fileInput.click());
  dropzone.addEventListener('drop', e => {
    const files = Array.from(e.dataTransfer.files || []);
    if(files.length) uploadFiles(files);
  });
  fileInput && fileInput.addEventListener('change', e => {
    const files = Array.from(fileInput.files || []);
    if(files.length) uploadFiles(files);
  });

  async function uploadFiles(files){
    const fd = new FormData();
    files.forEach(f => fd.append('files', f));
  const resp = await fetch("{{ url_for('admin.upload_tiles') }}", { method: 'POST', body: fd });
    // Reload to render server-side parsed previews and messages
    if(resp.ok){ window.location.reload(); } else { alert('Upload failed'); }
  }

  // Upload selected button label updater
  function updateUploadSelectedButton(){
    const boxes = checkedBoxes();
    const n = boxes.length;
    if(uploadSelectedBtn){
      // Keep concise label; optionally append count when > 0
      uploadSelectedBtn.textContent = n > 0 ? `Upload ${n}` : 'Upload';
      uploadSelectedBtn.disabled = n === 0;
    }
    if(deleteSelected){
      deleteSelected.textContent = n > 0 ? `Delete ${n}` : 'Delete';
      deleteSelected.disabled = n === 0;
    }
    if(downloadSelected){
      downloadSelected.textContent = n > 0 ? `Download ${n}` : 'Download';
      downloadSelected.disabled = n === 0;
    }
    if(selectedCountEl){ selectedCountEl.textContent = String(n); }
    // keep label visible as per request, but show 0 when nothing selected
  }

  async function postAction(url, name){
    const body = new URLSearchParams(); body.set('name', name);
    const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' }, body: body.toString() });
    return resp;
  }

  async function ingestOne(name){
    if(!name) return;
    // Check potential overwrite
    let proceed = true;
    try{
      const chk = await fetch("{{ url_for('admin.upload_tiles_check') }}?name="+encodeURIComponent(name), { headers: { 'X-Requested-With': 'fetch' }});
      if(chk.ok){ const data = await chk.json(); if(data.exists){ proceed = confirm(`A current dataset exists for ${name}. Overwrite?`); } }
    }catch(_e){ /* ignore */ }
    if(!proceed) return;
    const params = new URLSearchParams(); params.set('name', name); params.set('confirm', '1');
    const resp = await fetch("{{ url_for('admin.upload_tiles_ingest') }}", { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' }, body: params.toString() });
    if(!resp.ok){
      if(resp.status === 409){
        const ask = confirm(`A current dataset exists for ${name}. Overwrite?`);
        if(ask){
          const retryParams = new URLSearchParams(); retryParams.set('name', name); retryParams.set('confirm', '1');
          const retry = await fetch("{{ url_for('admin.upload_tiles_ingest') }}", { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' }, body: retryParams.toString() });
          if(!retry.ok){
            try { const data = await retry.json(); alert(`Failed to ingest ${name}: ${data.error || data.message || retry.status}`); } catch(_e) { alert(`Failed to ingest ${name}.`); }
            return false;
          }
        } else { return; }
      } else {
        try { const data = await resp.json(); alert(`Failed to ingest ${name}: ${data.error || data.message || resp.status}`); } catch(_e) { alert(`Failed to ingest ${name}.`); }
        return false;
      }
    }
    return true;
  }
  // Per-row ingest button
  document.querySelectorAll('.ingest-one').forEach(btn => {
    btn.addEventListener('click', async () => {
      const name = btn.dataset.file;
      const ok = await ingestOne(name);
      if(ok){
        window.location.href = "{{ url_for('admin.upload_tiles') }}?message="+encodeURIComponent(`Ingested ${name}.`)+"&success=1";
      } else {
        alert(`Failed to ingest ${name}. See server logs for details.`);
        window.location.reload();
      }
    });
  });

  if(uploadSelectedBtn){
    uploadSelectedBtn.addEventListener('click', async ()=>{
      const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
      // Compute quick summary from each row's data-exists flag
      let overwrite = 0, fresh = 0;
      for(const cb of boxes){
        const row = cb.closest('.tile-preview');
        const existsHint = row && row.dataset.exists === '1';
        if(existsHint){ overwrite++; } else { fresh++; }
      }
      const proceed = confirm(`You're about to upload ${boxes.length} file${boxes.length===1?'':'s'}:\n\n`+
        `â€¢ ${fresh} new\n`+
        `â€¢ ${overwrite} overwrite`+
        `\n\nContinue?`);
      if(!proceed) return;
      let allOk = true;
      for(const cb of boxes){
        const name = cb.dataset.file;
        const ok = await ingestOne(name);
        if(!ok) allOk = false;
      }
      if(allOk){
        window.location.href = "{{ url_for('admin.upload_tiles') }}?message="+encodeURIComponent('New files ingested.')+"&success=1";
      } else {
        alert('Some ingests failed. See server logs for details.');
        window.location.reload();
      }
    });
  }
  if(downloadSelected){
    downloadSelected.addEventListener('click', ()=>{
      const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
      // Trigger browser downloads sequentially
      for(const cb of boxes){
        const name = cb.dataset.file;
        const a = document.createElement('a');
        a.href = "{{ url_for('admin.upload_tiles_download', name='__NAME__') }}".replace('__NAME__', encodeURIComponent(name));
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
    });
  }
  deleteSelected.addEventListener('click', async ()=>{
    const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
    if(!confirm('Delete selected temp files?')) return;
  for(const cb of boxes){ const name = cb.dataset.file; await postAction("{{ url_for('admin.upload_tiles_delete') }}", name); }
    window.location.reload();
  });

  // Replace functionality removed from UI as per requirements.

  // Initial
  document.addEventListener('change', (e)=>{
    if(e.target.classList && e.target.classList.contains('row-check')){
      updateUploadSelectedButton();
    }
  });
  updateUploadSelectedButton();
  filter();
})();
</script>
{% endblock %}

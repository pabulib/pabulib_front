{% extends 'base.html' %}

{% block bodyClass %}admin{% endblock %}
{% block title %}Upload Tiles{% endblock %}

{% block body %}
{% include 'admin/_navbar.html' %}
<section class="max-w-7xl mx-auto px-4">
  <div class="flex gap-6 justify-center">
    <!-- Sidebar filters (left) to match admin dashboard/delete -->
    <aside class="hidden md:block w-64 shrink-0 mt-8">
      <div class="bg-white rounded-lg shadow-lg p-5 sticky top-24">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">Filters</h2>

        <div class="mb-2">
          <label for="filterStatus" class="block text-sm font-medium text-slate-700 mb-1">Status</label>
          <select id="filterStatus" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-800 focus:ring-2 focus:ring-indigo-500">
            <option value="">All files</option>
            <option value="new">New only</option>
            <option value="existing">Existing (overwrite)</option>
          </select>
        </div>

        <div class="mb-2">
          <label for="filterValidation" class="block text-sm font-medium text-slate-700 mb-1">Validation</label>
          <select id="filterValidation" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-800 focus:ring-2 focus:ring-indigo-500">
            <option value="">All files</option>
            <option value="valid">Valid only</option>
            <option value="invalid">Invalid only</option>
          </select>
        </div>

        <button id="filtersClear" type="button" class="mt-4 w-full px-3 py-2 text-sm rounded-md border border-slate-300 text-slate-600 hover:bg-slate-50">Clear filters</button>
      </div>
    </aside>

    <div class="w-full max-w-5xl">
      <div class="w-full bg-white rounded-lg shadow-lg p-6 mt-8">
        <div class="flex items-baseline justify-between mb-4">
          <h1 class="text-3xl font-bold text-slate-800">Admin – Upload Tiles</h1>
          <span class="text-sm text-slate-500">{{ count or 0 }} PB files</span>
        </div>
  <p class="text-gray-600 mb-6">These are temporary uploads. You can upload them as new files or remove them from the temporary area.</p>

        <!-- Subtle legend -->
        <div class="text-xs text-slate-500 mb-4 flex items-center gap-3">
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-emerald-200 bg-emerald-100 text-emerald-800" title="Valid file">✓ Valid</span>
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-red-200 bg-red-100 text-red-800" title="Invalid file">✗ Invalid</span>
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-blue-200 bg-blue-50 text-blue-700" title="File will be uploaded as a new dataset">New</span>
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-orange-200 bg-orange-50 text-orange-700" title="File will overwrite an existing dataset">Overwrite</span>
        </div>

        <!-- Toolbar: search + bulk actions (mirrors admin dashboard style) -->
        <div class="mb-4 flex items-start gap-6">
          <!-- Left group: search + x/x + select all -->
          <div class="flex items-center gap-4 flex-1 min-w-0">
            <div class="relative w-full max-w-xs">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 4.238 12.03l4.241 4.241a.75.75 0 1 0 1.06-1.06l-4.24-4.242A6.75 6.75 0 0 0 10.5 3.75Zm-5.25 6.75a5.25 5.25 0 1 1 10.5 0 5.25 5.25 0 0 1-10.5 0Z" clip-rule="evenodd"/></svg>
            </span>
            <input id="tmpSearch" type="text" placeholder="Search titles…" class="w-full pl-10 pr-10 py-2.5 rounded-md border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-800 placeholder-slate-400" />
            <button id="tmpSearchClear" type="button" class="hidden absolute inset-y-0 right-0 pr-3 text-slate-400 hover:text-slate-600" aria-label="Clear search">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12 2.25a9.75 9.75 0 1 0 0 19.5 9.75 9.75 0 0 0 0-19.5Zm-2.47 6.78a.75.75 0 0 1 1.06 0L12 10.44l1.41-1.41a.75.75 0 0 1 1.06 1.06L13.06 11.5l1.41 1.41a.75.75 0 1 1-1.06 1.06L12 12.56l-1.41 1.41a.75.75 0 0 1-1.06-1.06l1.41-1.41-1.41-1.41a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd"/></svg>
            </button>
          </div>
            <span id="tmpCount" class="text-sm text-slate-500 whitespace-nowrap"></span>
            <label class="inline-flex items-center gap-2 text-slate-700">
              <input id="tmpSelectAll" type="checkbox" class="w-4 h-4">
              <span>Select all</span>
            </label>
          </div>

          <!-- Right group: selected label (left) + stacked actions (right) -->
          <div class="shrink-0 flex items-center gap-3">
            <!-- Responsive action group: horizontal on sm+, stacked on xs -->
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-0">
              <div class="inline-flex rounded-md shadow-sm ring-1 ring-slate-300 overflow-hidden divide-y sm:divide-y-0 sm:divide-x divide-slate-200">
                <button id="uploadSelectedBtn" type="button" title="Upload selected" class="inline-flex items-center gap-2 px-3 py-2 bg-emerald-100 text-emerald-800 hover:bg-emerald-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 3a.75.75 0 0 1 .75.75V14a.75.75 0 0 1-1.5 0V3.75A.75.75 0 0 1 12 3Z"/><path d="M7.72 8.47a.75.75 0 0 1 1.06 0L12 11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-3.75 3.75a1.5 1.5 0 0 1-2.12 0L7.72 9.53a.75.75 0 0 1 0-1.06Z"/><path d="M6.75 18A3.75 3.75 0 0 1 10.5 14.25h3A3.75 3.75 0 0 1 17.25 18v1.5H6.75V18Z"/></svg>
                  <span id="uploadLabel" class="hidden sm:inline">Upload</span>
                </button>
                <button type="button" id="downloadSelected" title="Download selected" class="inline-flex items-center gap-2 px-3 py-2 bg-white text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 3.75a.75.75 0 0 1 .75.75v9.44l2.47-2.47a.75.75 0 1 1 1.06 1.06l-3.75 3.75a1.5 1.5 0 0 1-2.12 0L6.66 12.53a.75.75 0 0 1 1.06-1.06l2.53 2.53V4.5a.75.75 0 0 1 .75-.75Z"/><path d="M6.75 18A3.75 3.75 0 0 1 10.5 14.25h3A3.75 3.75 0 0 1 17.25 18v1.5H6.75V18Z"/></svg>
                  <span id="downloadLabel" class="hidden sm:inline">Download</span>
                </button>
                <button type="button" id="deleteSelected" title="Delete selected" class="inline-flex items-center gap-2 px-3 py-2 bg-red-100 text-red-800 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M9 3.75A1.5 1.5 0 0 1 10.5 2.25h3A1.5 1.5 0 0 1 15 3.75V4.5h3.75a.75.75 0 0 1 0 1.5H5.25a.75.75 0 0 1 0-1.5H9V3.75Z"/><path fill-rule="evenodd" d="M6.75 6.75h10.5l-.69 11.087A3 3 0 0 1 13.57 20.7H10.43a3 3 0 0 1-2.99-2.863L6.75 6.75Zm4.5 3a.75.75 0 0 0-1.5 0v6a.75.75 0 1 0 1.5 0v-6Zm3 0a.75.75 0 0 0-1.5 0v6a.75.75 0 1 0 1.5 0v-6Z" clip-rule="evenodd"/></svg>
                  <span id="deleteLabel" class="hidden sm:inline">Delete</span>
                </button>
              </div>
            </div>
          </div>
        </div>

          {% if message %}
          <div class="p-3 rounded-md text-sm {{ 'bg-green-50 text-green-700 border border-green-200' if success else 'bg-red-50 text-red-700 border border-red-200' }}">
            {{ message }}
          </div>
          {% endif %}

          {% if results %}
          <div class="mt-3 space-y-2">
            {% for r in results %}
            <div class="p-2 rounded-md text-xs border {{ 'bg-emerald-50 border-emerald-200' if r.ok else 'bg-red-50 border-red-200' }}">
              <div class="flex items-start gap-2">
                <span class="{{ 'text-emerald-700' if r.ok else 'text-red-700' }}">{{ '✓' if r.ok else '✗' }}</span>
                <div class="flex-1">
                  <span class="font-medium">{{ r.name }}</span>: {{ r.msg }}
                  {% if r.validation %}
                  <div class="mt-1 {{ 'text-emerald-700' if r.validation.valid else ('text-orange-600' if r.validation.error_message else 'text-red-700') }}">
                    {{ r.validation_summary }}
                  </div>
                  {% if r.validation.errors %}
                  <div class="mt-1 text-red-600">
                    <div class="font-medium">Errors:</div>
                    <ul class="list-disc list-inside ml-2">
                      {% for error_type, instances in r.validation.errors.items() %}
                        {% for instance_id, message in instances.items() %}
                          <li>{{ error_type }}: {{ message }}</li>
                        {% endfor %}
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                  {% if r.validation.warnings %}
                  <div class="mt-1 text-orange-600">
                    <div class="font-medium">Warnings:</div>
                    <ul class="list-disc list-inside ml-2">
                      {% for warning_type, instances in r.validation.warnings.items() %}
                        {% for instance_id, message in instances.items() %}
                          <li>{{ warning_type }}: {{ message }}</li>
                        {% endfor %}
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          <div id="dropzone" class="border-2 border-dashed border-slate-300 rounded-md p-8 text-center text-slate-500 hover:border-slate-400 cursor-pointer">
            <div class="text-lg font-medium mb-1">Add files</div>
            <div class="text-sm">Drag & drop .pb files here, or click to choose</div>
            <input id="files" name="files" type="file" accept=".pb" multiple class="hidden" />
          </div>

          <!-- Progress bar (hidden by default) -->
          <div id="uploadProgress" class="hidden mt-4">
            <div class="bg-slate-100 rounded-full h-2.5 overflow-hidden">
              <div id="progressBar" class="bg-indigo-600 h-full transition-all duration-300 ease-out" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-sm text-slate-600 text-center">
              <div class="flex items-center justify-center gap-2">
                <span id="progressPhase" class="px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700">Upload</span>
                <span id="progressText">Uploading files...</span>
                <span id="progressPercent" class="font-medium">0%</span>
              </div>
            </div>
            <div class="text-xs text-slate-500 text-center mt-2 space-y-1">
              <div id="progressFileCount" class="hidden">
                Processing file <span id="currentFileNum">1</span> of <span id="totalFileNum">1</span>
              </div>
              <div id="progressFileName" class="hidden font-mono text-slate-600 truncate max-w-md mx-auto" title="">
                <!-- Current file webpage name will appear here -->
              </div>
              <div id="progressHint" class="text-slate-400">
                After upload completes, files will be validated. Please wait...
              </div>
            </div>
          </div>
        </div>

        <div class="mt-6 mb-12 space-y-4" id="tilesContainer">
    {% for t in tiles %}
    <section class="rounded-lg shadow p-4 tile-preview relative cursor-pointer hover:ring-4 transition-all {{ 'bg-red-50 ring-2 ring-red-200' if not t.validation.valid else 'bg-emerald-50 ring-2 ring-emerald-200' }}"
      data-title="{{ t.title|e }}"
      data-desc="{{ t.description|e }}"
      data-file="{{ t.file_name|e }}"
      data-exists="{{ '1' if t.exists_conflict else '' }}"
      data-valid="{{ '1' if t.validation.valid else '0' }}"
      onclick="toggleTileSelection(this, event)"
    >
      <div class="flex items-start gap-4">
        <input class="row-check mt-1.5" type="checkbox" data-file="{{ t.file_name|e }}" />
        
        {# Main tile info #}
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-slate-800 truncate" title="{{ t.title }}">{{ t.title }}</h2>
            {% if t.experimental %}
              <span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700">Experimental</span>
            {% endif %}
            {% if t.fully_funded %}
              <span class="text-xs px-2 py-0.5 rounded bg-emerald-100 text-emerald-700">Fully funded</span>
            {% endif %}
          </div>
          <div class="mt-1">
            {% if t.exists_conflict %}
              <span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700 border border-orange-200">Overwrite</span>
            {% else %}
              <span class="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700 border border-blue-200">New</span>
            {% endif %}
          </div>
          <div class="text-slate-600 text-sm mt-1">{{ t.description }}</div>
          <div class="text-slate-500 text-xs mt-1 font-mono break-words">{{ t.file_name }}</div>
          <div class="grid grid-cols-5 gap-3 mt-3 text-sm">
            <div class="text-slate-500"># votes<br><span class="text-slate-800">{{ t.num_votes }}</span></div>
            <div class="text-slate-500"># projects<br><span class="text-slate-800">{{ t.num_projects }}</span></div>
            <div class="text-slate-500">Budget<br><span class="text-slate-800">{{ t.budget }}</span></div>
            <div class="text-slate-500">Vote type<br><span class="text-slate-800">{{ t.vote_type }}</span></div>
            <div class="text-slate-500">Vote length<br><span class="text-slate-800">{{ t.vote_length }}</span></div>
          </div>
        </div>
        
        {# Validation Report Column #}
        {% if t.validation %}
        <div class="w-64 shrink-0 border-l border-slate-200 pl-4">
          <div class="text-xs font-medium text-slate-600 mb-2">Validation Report</div>
          <div class="flex items-start gap-2 mb-2">
            <span class="text-xl {{ 'text-emerald-600' if t.validation.valid else ('text-orange-600' if t.validation.error_message else 'text-red-600') }}">
              {{ '✓' if t.validation.valid else ('⚠' if t.validation.error_message else '✗') }}
            </span>
            <div class="flex-1 text-xs">
              <div class="{{ 'text-emerald-700 font-medium' if t.validation.valid else ('text-orange-700' if t.validation.error_message else 'text-red-700 font-medium') }}">
                {% if t.validation.valid %}
                  Valid file
                {% elif t.validation.error_message %}
                  {{ t.validation.error_message }}
                  {% if 'corrupted' in t.validation.error_message.lower() or 'parse error' in t.validation.error_message.lower() %}
                  <div class="mt-1 text-orange-600 font-semibold">⚠️ Note: This file cannot be validated and may be corrupted or malformed.</div>
                  {% endif %}
                {% else %}
                  Invalid file
                {% endif %}
              </div>
              {% if t.error_count > 0 %}
              <div class="text-red-700 mt-1">{{ t.error_count }} error{{ 's' if t.error_count != 1 else '' }}</div>
              {% endif %}
              {% if t.warning_count > 0 %}
              <div class="text-orange-700 mt-1">{{ t.warning_count }} warning{{ 's' if t.warning_count != 1 else '' }}</div>
              {% endif %}
            </div>
          </div>
          
          {% if t.validation.errors or t.validation.warnings %}
          <button type="button" class="text-xs text-indigo-600 hover:text-indigo-800 underline" onclick="toggleValidationDetails('{{ t.file_name|e }}')">
            Show details
          </button>
          
          {# Detailed validation errors/warnings (initially hidden) #}
          <div id="validation-{{ t.file_name|e }}" class="hidden mt-2 p-2 bg-slate-50 rounded text-xs space-y-2 max-h-48 overflow-y-auto">
            {% if t.validation.errors %}
            <div>
              <div class="font-semibold text-red-700 mb-1">Errors:</div>
              <ul class="list-disc list-inside space-y-1 text-red-600">
                {% for error_type, instances in t.validation.errors.items() %}
                  {% for instance_id, message in instances.items() %}
                    <li><span class="font-medium">{{ error_type }}:</span> {{ message }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            
            {% if t.validation.warnings %}
            <div>
              <div class="font-semibold text-orange-700 mb-1">Warnings:</div>
              <ul class="list-disc list-inside space-y-1 text-orange-600">
                {% for warning_type, instances in t.validation.warnings.items() %}
                  {% for instance_id, message in instances.items() %}
                    <li><span class="font-medium">{{ warning_type }}:</span> {{ message }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endif %}
        
        {# Action buttons column #}
        <div class="flex flex-col items-center gap-2 ml-2">
          <a class="p-2 rounded-md border border-slate-300 hover:bg-slate-50" title="Download" href="{{ url_for('admin.upload_tiles_download', name=t.file_name) }}">⬇</a>
          <div class="flex flex-col items-center gap-1">
            <button class="p-2 rounded-md border border-slate-300 hover:bg-slate-50 ingest-one" data-file="{{ t.file_name|e }}" title="Upload" type="button">⤴</button>
            {% if t.exists_conflict %}
              <span class="text-[10px] text-orange-600" title="A current dataset exists; ingest will overwrite.">overwrite</span>
            {% endif %}
          </div>
          <button class="p-2 rounded-md border border-slate-300 hover:bg-slate-50 text-red-700 delete-one" data-file="{{ t.file_name|e }}" title="Delete" type="button">🗑</button>
        </div>
      </div>
    </section>
    {% endfor %}
    {% if not tiles or tiles|length == 0 %}
      <div class="text-center text-slate-500">No temporary uploads yet.</div>
    {% endif %}
  </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('files');
  const tiles = Array.from(document.querySelectorAll('.tile-preview'));
  const countEl = document.getElementById('tmpCount');
  const selectAll = document.getElementById('tmpSelectAll');
  const search = document.getElementById('tmpSearch');
  const searchClear = document.getElementById('tmpSearchClear');
  const statusSel = document.getElementById('filterStatus');
  const validationSel = document.getElementById('filterValidation');
  const clearFilters = document.getElementById('filtersClear');
  const uploadSelectedBtn = document.getElementById('uploadSelectedBtn');
  const deleteSelected = document.getElementById('deleteSelected');
  const downloadSelected = document.getElementById('downloadSelected');
  const uploadLabel = document.getElementById('uploadLabel');
  const downloadLabel = document.getElementById('downloadLabel');
  const deleteLabel = document.getElementById('deleteLabel');
  // Removed explicit Selected: X label from UI; keep internal count only if needed.
  // const replaceWithSelected = document.getElementById('replaceWithSelected');
  const total = tiles.length;
  // Collect filenames that were not loaded due to pre-flight checks (with reasons)
  // Shape: { name: string, reason: string }
  const preflightRejected = [];

  // On load: display any pending upload report saved before reload
  try{
    const stored = localStorage.getItem('pabulibUploadReport');
    if(stored){
      const payload = JSON.parse(stored);
      if(payload && payload.summary){ renderBannerSummary(payload); }
      localStorage.removeItem('pabulibUploadReport');
    }
  }catch(_e){}

  function updateCount(){
    const visible = tiles.filter(t => t.style.display !== 'none').length;
    if(countEl) countEl.textContent = `${visible} / ${total}`;
  }

  function filter(){
    const q = (search.value || '').toLowerCase().trim();
    const fs = (statusSel && statusSel.value) || '';
    const fv = (validationSel && validationSel.value) || '';
    tiles.forEach(t => {
      const title = (t.dataset.title || '').toLowerCase();
      const desc = (t.dataset.desc || '').toLowerCase();
      const file = (t.dataset.file || '').toLowerCase();
      const textMatch = !q || title.includes(q) || desc.includes(q) || file.includes(q);
      const exists = t.dataset.exists === '1';
      const statusMatch = !fs || (fs === 'existing' ? exists : !exists);
      const isValid = t.dataset.valid === '1';
      const validationMatch = !fv || (fv === 'valid' ? isValid : !isValid);
      const match = textMatch && statusMatch && validationMatch;
      t.style.display = match ? '' : 'none';
    });
    updateCount();
  }

  function checkedBoxes(){
    return Array.from(document.querySelectorAll('.row-check')).filter(cb => cb.checked && cb.closest('.tile-preview').style.display !== 'none');
  }

  if(search){
    let tid=null; search.addEventListener('input', ()=>{ if(tid) cancelAnimationFrame(tid); tid=requestAnimationFrame(()=>{ filter(); const has= (search.value||'').length>0; if(searchClear) searchClear.classList.toggle('hidden', !has); }); });
  }
  if(searchClear){
    searchClear.addEventListener('click', ()=>{ search.value=''; filter(); search.focus(); searchClear.classList.add('hidden'); });
  }
  if(statusSel){
    statusSel.addEventListener('change', ()=>{ filter(); });
  }
  if(validationSel){
    validationSel.addEventListener('change', ()=>{ filter(); });
  }
  if(clearFilters){
    clearFilters.addEventListener('click', ()=>{ if(statusSel) statusSel.value=''; if(validationSel) validationSel.value=''; filter(); });
  }
  if(selectAll){
    selectAll.addEventListener('change', ()=>{
      tiles.forEach(t => { if(t.style.display !== 'none'){ const cb=t.querySelector('.row-check'); if(cb) cb.checked = selectAll.checked; }});
      updateUploadSelectedButton();
    });
  }

  // Dropzone
  function highlight(on){ dropzone.classList.toggle('ring-2', on); dropzone.classList.toggle('ring-indigo-500', on); }
  ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); highlight(true);}));
  ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); highlight(false);}));
  dropzone.addEventListener('click', ()=> fileInput && fileInput.click());
  dropzone.addEventListener('drop', e => {
    const files = Array.from(e.dataTransfer.files || []);
    if(files.length) uploadFiles(files);
  });
  fileInput && fileInput.addEventListener('change', e => {
    const files = Array.from(fileInput.files || []);
    if(files.length) uploadFiles(files);
  });

  async function uploadFiles(files){
    // Show progress bar
    const progressContainer = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressPercent = document.getElementById('progressPercent');
    const progressPhase = document.getElementById('progressPhase');
    const progressFileCount = document.getElementById('progressFileCount');
    const progressFileName = document.getElementById('progressFileName');
    const progressHint = document.getElementById('progressHint');
    const currentFileNum = document.getElementById('currentFileNum');
    const totalFileNum = document.getElementById('totalFileNum');
    
    if(progressContainer) {
      progressContainer.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressPercent.textContent = '0%';
      progressText.textContent = `Uploading ${files.length} file${files.length === 1 ? '' : 's'}...`;
      if(progressPhase) {
        progressPhase.textContent = 'Upload';
        progressPhase.className = 'px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700';
      }
      if(progressFileCount) progressFileCount.classList.add('hidden');
      if(progressFileName) progressFileName.classList.add('hidden');
      if(progressHint) progressHint.textContent = 'After upload completes, files will be validated. Please wait...';
    }
    
    // Pre-flight checks: only .pb and <= 10 MB
    const MAX_SIZE = 10 * 1024 * 1024; // 10 MB
    const rejected = [];
    const okFiles = [];
    for(const f of files){
      const name = f.name || '';
      if(!name.toLowerCase().endsWith('.pb')){
        rejected.push({ name, reason: 'Only .pb files are allowed' });
        continue;
      }
      if(typeof f.size === 'number' && f.size > MAX_SIZE){
        rejected.push({ name, reason: 'File too large (>10 MB)' });
        continue;
      }
      okFiles.push(f);
    }
    if(rejected.length){
      rejected.forEach(r => preflightRejected.push({ name: r.name, reason: r.reason }));
    }
    if(okFiles.length === 0){
      if(progressContainer) progressContainer.classList.add('hidden');
      return;
    }

    // Note: Server will also check for webpage_name duplicates based on META data
    // First try uploading without force_replace to detect duplicates
    let fd = new FormData();
    okFiles.forEach(f => fd.append('files', f));
    
  // Create XMLHttpRequest to track upload progress
  const xhr = new XMLHttpRequest();
    
    // Track upload progress
    xhr.upload.addEventListener('progress', (e) => {
      if(e.lengthComputable && progressBar && progressPercent) {
        const percentComplete = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = percentComplete + '%';
        progressPercent.textContent = percentComplete + '%';
      }
    });
    
    // Handle response
    const uploadPromise = new Promise((resolve, reject) => {
      xhr.onload = () => {
        if(xhr.status >= 200 && xhr.status < 300) {
          // Try to parse JSON first (our endpoint now supports JSON when X-Requested-With is fetch)
          let parsed = null;
          try { parsed = JSON.parse(xhr.responseText); } catch(_e) {}
          if(parsed && typeof parsed === 'object' && parsed.results){
            resolve({ ok: true, json: () => Promise.resolve(parsed) });
          } else {
            resolve({ ok: true, text: () => Promise.resolve(xhr.responseText) });
          }
        } else {
          reject(new Error('Upload failed'));
        }
      };
      xhr.onerror = () => reject(new Error('Upload failed'));
    });
    
  xhr.open('POST', "{{ url_for('admin.upload_tiles') }}", true);
  xhr.setRequestHeader('X-Requested-With', 'fetch');
  xhr.send(fd);
    
    let resp;
    try {
      resp = await uploadPromise;
    } catch(error) {
      if(progressContainer) progressContainer.classList.add('hidden');
      alert('Upload failed');
      return;
    }
    
    if(resp.ok){
      // Prefer JSON pathway when available
  let uploadJson = null;
      let html = '';
      if(resp.json){
        uploadJson = await resp.json();
      } else if(resp.text) {
        html = await resp.text();
      }
      const hasDuplicateWarning = (html && (html.includes('duplicate webpage_name') || html.includes('Duplicate detected')))
        || (uploadJson && uploadJson.overwrites_rejected && uploadJson.overwrites_rejected.length > 0);

      // Try to extract saved filenames from the HTML so we validate the correct names
      const savedNames = [];
      if(uploadJson && uploadJson.results){
        uploadJson.results.forEach(r => {
          // server returns name (final saved) and original_name when applicable
          if(r && r.name && r.ok){ savedNames.push(r.name); }
        });
      } else if(html){
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        try{
          doc.querySelectorAll('.mt-3 .p-2 .flex-1').forEach(node => {
            const text = node.textContent || '';
            const m = text.match(/Saved as\s+([\w\-\.]+\.pb)/i);
            const nameLabel = node.querySelector('.font-medium');
            const labelName = nameLabel ? (nameLabel.textContent || '').trim() : null;
            if(m && m[1]){
              savedNames.push(m[1]);
            } else if(labelName && labelName.endsWith('.pb')){
              savedNames.push(labelName);
            }
          });
        }catch(_e){}
      }
      // Collect upload-time issues (e.g., parse errors, wrong extension) into banner list
      const uploadIssues = [];
      if(uploadJson && uploadJson.results){
        uploadJson.results.forEach(r => {
          if(r && r.ok === false){
            const nm = (r.name || r.original_name || '');
            const why = (r.msg || 'upload rejected');
            uploadIssues.push({ name: nm, reason: why, webpage_name: r.webpage_name });
          }
        });
      }
      
      if(hasDuplicateWarning){
        // Hide progress bar before showing confirmation
        if(progressContainer) progressContainer.classList.add('hidden');
        
        // Extract webpage_names from JSON if available; fallback to HTML parse
        const webpageNames = [];
        if(uploadJson && uploadJson.overwrites_rejected){
          uploadJson.overwrites_rejected.forEach(n => { if(n && !webpageNames.includes(n)) webpageNames.push(n); });
        }
        if(webpageNames.length === 0 && html){
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
        
        // Look for the main warning message that contains the list of webpage_names
        const messageDiv = doc.querySelector('.bg-red-50.text-red-700, .bg-red-100.text-red-700');
        if(messageDiv){
          const text = messageDiv.textContent;
          // Extract webpage_names from the message after "duplicate webpage_name: " or "duplicates: "
          const match = text.match(/(?:duplicate webpage_name|duplicates):\s*(.+?)(?:\s*$|\s*⚠|\s*Do you)/);
          if(match && match[1]){
            // Split by comma and clean up each name
            const names = match[1].split(',').map(n => n.trim()).filter(n => n);
            names.forEach(name => {
              if(!webpageNames.includes(name)){
                webpageNames.push(name);
              }
            });
          }
        }
        
        // Also check individual error messages for webpage_names
  if(webpageNames.length === 0){
          const errorDivs = doc.querySelectorAll('.text-red-700, .text-red-600');
          errorDivs.forEach(div => {
            const text = div.textContent;
            const match = text.match(/webpage_name '([^']+)'/);
            if(match && match[1] && !webpageNames.includes(match[1])){
              webpageNames.push(match[1]);
            }
          });
        }
        
        // Close HTML parsing branch
      }

        // Only show confirmation dialog if there are actual webpage_names to replace
        // If the list is empty, it means files were uploaded successfully without conflicts
        if(webpageNames.length === 0){
          // No actual duplicates - just reload to show the uploaded files
          // Transition to validation phase
          if(progressPhase) {
            progressPhase.textContent = 'Validation';
            progressPhase.className = 'px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700';
          }
          if(progressText) progressText.textContent = 'Preparing validation...';
          if(progressBar) progressBar.style.width = '100%';
          if(progressPercent) progressPercent.textContent = '100%';
          if(progressHint) progressHint.textContent = 'Upload complete. Starting validation...';
          await new Promise(resolve => setTimeout(resolve, 300));
          
          const namesToValidate = savedNames.length ? savedNames : okFiles.map(f => f.name);
          const summary = await validateUploadedFiles(namesToValidate);
          // Merge in pre-flight not-loaded items and upload-time issues
          // Build structured notLoaded list for banner table
          const notLoaded = ([]).concat(preflightRejected).concat(uploadIssues);
          if(preflightRejected.length){
            summary.failedNames = (summary.failedNames || []).concat(preflightRejected.map(i => `${i.name} — ${i.reason}`));
          }
          if(uploadIssues.length){
            summary.failedNames = (summary.failedNames || []).concat(uploadIssues.map(i => `${i.name} — ${i.reason}`));
          }
          const payload = { phase: 'validation', summary: { ...summary, notLoaded } };
          try{ localStorage.setItem('pabulibUploadReport', JSON.stringify(payload)); }catch(_e){}
          renderBannerSummary(payload);
          setTimeout(() => window.location.reload(), 1200);
          return;
        }
        
        // Build a nice confirmation message with the list of webpage_names
        let confirmMsg = `Some files were rejected because they have the same webpage_name (based on META data: country, unit, instance, subunit) as existing temp files.\n\n`;
        confirmMsg += `The following webpage_names already exist:\n`;
        webpageNames.forEach(name => {
          confirmMsg += `  • ${name}\n`;
        });
        confirmMsg += `\n`;
        confirmMsg += `Do you want to REPLACE the existing temp files with the new ones?`;
        
        const proceed = confirm(confirmMsg);
        
        if(proceed){
          // Show progress again for re-upload
          if(progressContainer) {
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            progressText.textContent = `Re-uploading ${okFiles.length} file${okFiles.length === 1 ? '' : 's'}...`;
            if(progressPhase) {
              progressPhase.textContent = 'Re-upload';
              progressPhase.className = 'px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700';
            }
            if(progressFileCount) progressFileCount.classList.add('hidden');
            if(progressFileName) progressFileName.classList.add('hidden');
            if(progressHint) progressHint.textContent = 'Replacing existing files, then validating. Please wait...';
          }
          
          // Re-upload with force_replace flag
          fd = new FormData();
          okFiles.forEach(f => fd.append('files', f));
          fd.append('force_replace', '1');
          
          const xhr2 = new XMLHttpRequest();
          
          xhr2.upload.addEventListener('progress', (e) => {
            if(e.lengthComputable && progressBar && progressPercent) {
              const percentComplete = Math.round((e.loaded / e.total) * 100);
              progressBar.style.width = percentComplete + '%';
              progressPercent.textContent = percentComplete + '%';
            }
          });
          
          const reuploadPromise = new Promise((resolve, reject) => {
            xhr2.onload = () => {
              if(xhr2.status >= 200 && xhr2.status < 300) {
                resolve({ ok: true });
              } else {
                reject(new Error('Re-upload failed'));
              }
            };
            xhr2.onerror = () => reject(new Error('Re-upload failed'));
          });
          
          xhr2.open('POST', "{{ url_for('admin.upload_tiles') }}", true);
          xhr2.send(fd);
          
          try {
            resp = await reuploadPromise;
            if(progressText) progressText.textContent = 'Preparing validation...';
            if(progressPhase) {
              progressPhase.textContent = 'Validation';
              progressPhase.className = 'px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700';
            }
            if(progressBar) progressBar.style.width = '100%';
            if(progressPercent) progressPercent.textContent = '100%';
            if(progressHint) progressHint.textContent = 'Upload complete. Starting validation...';
            
            // Add a small delay to show the validation message
            await new Promise(resolve => setTimeout(resolve, 300));
          } catch(error) {
            if(progressContainer) progressContainer.classList.add('hidden');
            alert('Re-upload failed');
            return;
          }
        } else {
          // User cancelled, just hide progress and return
          if(progressContainer) progressContainer.classList.add('hidden');
          return;
        }
      }
      
      // After successful upload, validate files with progress
      // Transition to validation phase
      if(progressPhase) {
        progressPhase.textContent = 'Validation';
        progressPhase.className = 'px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700';
      }
      if(progressText) progressText.textContent = 'Preparing validation...';
      if(progressBar) progressBar.style.width = '100%';
      if(progressPercent) progressPercent.textContent = '100%';
      if(progressHint) progressHint.textContent = 'Upload complete. Starting validation...';
      await new Promise(resolve => setTimeout(resolve, 300));
      
      const namesToValidate = savedNames.length ? savedNames : okFiles.map(f => f.name);
      const summary = await validateUploadedFiles(namesToValidate);
      const notLoaded = ([]).concat(preflightRejected).concat(uploadIssues);
      if(preflightRejected.length){
        summary.failedNames = (summary.failedNames || []).concat(preflightRejected.map(i => `${i.name} — ${i.reason}`));
      }
      if(uploadIssues.length){
        summary.failedNames = (summary.failedNames || []).concat(uploadIssues.map(i => `${i.name} — ${i.reason}`));
      }
      const payload = { phase: 'validation', summary: { ...summary, notLoaded } };
      try{ localStorage.setItem('pabulibUploadReport', JSON.stringify(payload)); }catch(_e){}
      renderBannerSummary(payload);
      
      // Reload to render server-side parsed previews and messages
      window.location.reload();
    } else {
      if(progressContainer) progressContainer.classList.add('hidden');
  const failedList = okFiles.map(f=>({ name: f.name, reason: 'upload failed' }));
  renderBannerSummary({ phase: 'upload', summary: { total: okFiles.length, ok: 0, invalid: 0, errored: okFiles.length, failedNames: failedList.map(i => `${i.name} — ${i.reason}`), notLoaded: failedList, errors: ['Upload failed'] } });
    }
  }

  // Validate uploaded files with progress tracking - one by one for better progress display
  async function validateUploadedFiles(filenames) {
    const progressContainer = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressPercent = document.getElementById('progressPercent');
    const progressPhase = document.getElementById('progressPhase');
    const progressFileCount = document.getElementById('progressFileCount');
    const progressFileName = document.getElementById('progressFileName');
    const progressHint = document.getElementById('progressHint');
    const currentFileNum = document.getElementById('currentFileNum');
    const totalFileNum = document.getElementById('totalFileNum');
    
    if(!filenames || filenames.length === 0) return;
    
  try {
      // Ensure the progress UI is visible and in view
      if(progressContainer){
        progressContainer.classList.remove('hidden');
        try { progressContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(_e) {}
      }
      // Transition to validation phase
      if(progressPhase) {
        progressPhase.textContent = 'Validation';
        progressPhase.className = 'px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700';
      }
      if(progressText) progressText.textContent = 'Starting validation...';
      if(progressBar) progressBar.style.width = '0%';
      if(progressPercent) progressPercent.textContent = '0%';
      if(progressHint) progressHint.textContent = 'Analyzing file structure and content...';
      if(progressFileCount) {
        progressFileCount.classList.remove('hidden');
        if(totalFileNum) totalFileNum.textContent = filenames.length;
        if(currentFileNum) currentFileNum.textContent = '0';
      }
      
      // Validate files one by one for better progress feedback
      const results = [];
      let okCount = 0, invalidCount = 0, erroredCount = 0;
      const failedNames = [];
      for(let i = 0; i < filenames.length; i++) {
        const filename = filenames[i];
        const percent = Math.round(((i + 1) / filenames.length) * 100);
        
        if(progressBar) progressBar.style.width = percent + '%';
        if(progressPercent) progressPercent.textContent = percent + '%';
        if(progressText) progressText.textContent = `Validating files...`;
        if(currentFileNum) currentFileNum.textContent = (i + 1).toString();
        
        // Show current filename first (as fallback)
        if(progressFileName) {
          progressFileName.classList.remove('hidden');
          progressFileName.textContent = filename;
          progressFileName.title = filename;
        }
        
        try {
          const resp = await fetch("{{ url_for('admin.upload_tiles_validate_single') }}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ file: filename })
          });
          
          if(resp.ok) {
            const result = await resp.json();
            results.push(result);
            
            // Update display with actual webpage name if available
            if(progressFileName) {
              let displayName = '';
              if(result.webpage_name) {
                displayName = result.webpage_name;
              } else if(result.title) {
                displayName = result.title;
              } else if(result.name) {
                displayName = result.name;
              } else if(result.file) {
                displayName = result.file;
              } else {
                displayName = filename;
              }
              
              progressFileName.textContent = displayName;
              progressFileName.title = displayName;
            }
            
            // Update counts and hint based on validation status
            const isValid = !!(result.validation && result.validation.valid);
            if(isValid) {
              okCount++;
              if(progressHint){
                progressHint.textContent = '✓ File validated successfully';
                progressHint.className = 'text-emerald-600';
              }
            } else {
              invalidCount++;
              failedNames.push(progressFileName ? (progressFileName.textContent || filename) : filename);
              if(progressHint){
                progressHint.textContent = '⚠ File has validation issues';
                progressHint.className = 'text-orange-600';
              }
            }
          } else {
            // If individual validation fails, continue with others
            console.warn(`Failed to validate ${filename}`);
            erroredCount++;
            failedNames.push(filename);
            if(progressHint) {
              progressHint.textContent = '⚠ Validation error occurred';
              progressHint.className = 'text-orange-600';
            }
          }
        } catch(error) {
          console.error(`Error validating ${filename}:`, error);
          erroredCount++;
          failedNames.push(filename);
          if(progressHint) {
            progressHint.textContent = '⚠ Validation error occurred';
            progressHint.className = 'text-orange-600';
          }
        }
        
        // Small delay to show progress and let users see the webpage names
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
  // Final validation complete message
      if(progressText) progressText.textContent = 'Validation complete!';
      if(progressHint) {
        progressHint.textContent = 'All files processed. Refreshing view...';
        progressHint.className = 'text-slate-400';
      }
  if(progressFileName) progressFileName.classList.add('hidden');

  // Build a compact summary for caller
  return { total: filenames.length, ok: okCount, invalid: invalidCount, errored: erroredCount, failedNames };
      
    } catch(error) {
      console.error('Validation error:', error);
      if(progressText) progressText.textContent = 'Validation completed with errors';
      if(progressHint) {
        progressHint.textContent = 'Some validation errors occurred. Check results below.';
        progressHint.className = 'text-orange-600';
      }
      // Continue anyway - validation errors shouldn't block the upload
      return { total: (filenames || []).length, ok: 0, invalid: (filenames || []).length, errored: 0, failedNames: filenames || [] };
    }
  }

  // Render a persistent banner summary above the dropzone (same place as Deleted files message)
  function renderBannerSummary(payload){
    try{
      const container = document.querySelector('.w-full.bg-white.rounded-lg.shadow-lg.p-6.mt-8');
      if(!container) return;

      // Find or create banner area at top (just below title block)
      let banner = container.querySelector('[data-banner]');
      if(!banner){
        banner = document.createElement('div');
        banner.setAttribute('data-banner', '1');
        banner.className = 'mb-4';
        // Insert after the header section (first child div)
        const insertAfter = container.firstElementChild && container.firstElementChild.nextElementSibling ? container.firstElementChild.nextElementSibling : container.firstElementChild;
        if(insertAfter && insertAfter.nextSibling){
          insertAfter.parentNode.insertBefore(banner, insertAfter.nextSibling);
        } else {
          container.prepend(banner);
        }
      }

      const summary = payload && payload.summary ? payload.summary : null;
      if(!summary) return;
      const { total, ok, invalid, errored, failedNames, errors, notLoaded } = summary;

      const lines = [];
      // Counters with subtle colors
      lines.push(`<div class="flex flex-col gap-1">
        <div class="text-emerald-700"><strong>Valid:</strong> ${ok} file${ok===1?'':'s'}</div>
        <div class="text-orange-700"><strong>Processed but invalid:</strong> ${invalid||0} file${(invalid||0)===1?'':'s'}</div>
        <div class="text-red-700"><strong>Not loaded:</strong> ${(notLoaded && notLoaded.length) || 0} file${(notLoaded && notLoaded.length)===1?'':'s'}</div>
      </div>`);

      // Table of Not loaded with two columns
      if(notLoaded && notLoaded.length){
        const rows = notLoaded.map(item => {
          const display = bestDisplayName(item);
          const reason = item.reason || '';
          return `<tr class="border-b border-slate-200"><td class="py-1 pr-3 align-top">${escapeHtml(display)}</td><td class="py-1 text-red-700">${escapeHtml(reason)}</td></tr>`;
        }).join('');
        lines.push(`<div class="mt-3"><table class="w-full text-sm">
          <thead><tr class="text-slate-600"><th class="text-left font-medium pr-3">File</th><th class="text-left font-medium">Reason</th></tr></thead>
          <tbody>${rows}</tbody>
        </table></div>`);
      }

      banner.innerHTML = `<div class="p-4 rounded-md text-sm bg-emerald-50 border border-emerald-200">${lines.join('')}</div>`;

      // Add extra spacing above dropzone
      const drop = document.getElementById('dropzone');
      if(drop){ drop.style.marginTop = '2rem'; }
    }catch(_e){}
  }

  function escapeHtml(s){
    return String(s||'')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function bestDisplayName(item){
    // Prefer webpage_name if available; else derive from filename by stripping extension and prettifying
    if(item && item.webpage_name){ return item.webpage_name; }
    const n = (item && item.name) ? String(item.name) : '';
    return prettifyName(n);
  }

  function prettifyName(name){
    if(!name) return '';
    // strip extension
    const base = name.replace(/\.[^.]+$/, '');
    return base.replace(/_/g, ' ');
  }

  // Upload selected button label updater
  function updateUploadSelectedButton(){
    const boxes = checkedBoxes();
    const n = boxes.length;
    if(uploadSelectedBtn){ uploadSelectedBtn.disabled = n === 0; }
    if(deleteSelected){ deleteSelected.disabled = n === 0; }
    if(downloadSelected){ downloadSelected.disabled = n === 0; }
    if(uploadLabel){ uploadLabel.textContent = n > 0 ? `Upload ${n}` : 'Upload'; }
    if(deleteLabel){ deleteLabel.textContent = n > 0 ? `Delete ${n}` : 'Delete'; }
    if(downloadLabel){ downloadLabel.textContent = n > 0 ? `Download ${n}` : 'Download'; }
    // No external label to update
  }

  async function postAction(url, name){
    const body = new URLSearchParams(); body.set('name', name);
    const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' }, body: body.toString() });
    return resp;
  }

  // Upload a single temp file. When called from bulk flow, skipConfirm=true to avoid
  // any additional per-file confirmations; we rely on the single summary confirmation.
  async function ingestOne(name, skipConfirm){
    if(!name) return;
    // Optional pre-check (only when not already confirmed at batch level)
    if(!skipConfirm){
      let proceed = true;
      try{
        const chk = await fetch("{{ url_for('admin.upload_tiles_check') }}?name="+encodeURIComponent(name), { headers: { 'X-Requested-With': 'fetch' }});
        if(chk.ok){ const data = await chk.json(); if(data.exists){ proceed = confirm(`A current dataset exists for ${name}. Overwrite?`); } }
      }catch(_e){ /* ignore */ }
      if(!proceed) return;
    }
    const params = new URLSearchParams(); params.set('name', name); params.set('confirm', '1');
    const resp = await fetch("{{ url_for('admin.upload_tiles_ingest') }}", { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' }, body: params.toString() });
    if(!resp.ok){
      // If server reports conflict (409) but we already confirmed at batch level, don't prompt again.
      if(resp.status !== 409 || !skipConfirm){
        try { const data = await resp.json(); alert(`Failed to upload ${name}: ${data.error || data.message || resp.status}`); } catch(_e) { alert(`Failed to upload ${name}.`); }
        return false;
      }
    }
    return true;
  }
  // Per-row ingest button
  document.querySelectorAll('.ingest-one').forEach(btn => {
    btn.addEventListener('click', async () => {
      const name = btn.dataset.file;
      const tile = btn.closest('.tile-preview');
      const webpageName = tile ? (tile.dataset.title || name) : name;

      // Show progress bar for per-file ingest
      const progressContainer = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressPercent = document.getElementById('progressPercent');
      const progressPhase = document.getElementById('progressPhase');
      const progressFileCount = document.getElementById('progressFileCount');
      const progressFileName = document.getElementById('progressFileName');
      const progressHint = document.getElementById('progressHint');
      const currentFileNum = document.getElementById('currentFileNum');
      const totalFileNum = document.getElementById('totalFileNum');

      if(progressContainer){
        progressContainer.classList.remove('hidden');
        try { progressContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(_e) {}
        if(progressBar) progressBar.style.width = '0%';
        if(progressPercent) progressPercent.textContent = '0%';
        if(progressText) progressText.textContent = 'Processing 1 selected file...';
        if(progressPhase){
          progressPhase.textContent = 'Processing';
          progressPhase.className = 'px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700';
        }
        if(progressFileCount){
          progressFileCount.classList.remove('hidden');
          if(totalFileNum) totalFileNum.textContent = '1';
          if(currentFileNum) currentFileNum.textContent = '1';
        }
        if(progressFileName){
          progressFileName.classList.remove('hidden');
          progressFileName.textContent = webpageName;
          progressFileName.title = webpageName;
        }
        if(progressHint){
          progressHint.textContent = 'Uploading file to the main library...';
          progressHint.className = 'text-slate-400';
        }
      }

      // Per-row ingest keeps its own overwrite confirmation (skipConfirm=false)
      const ok = await ingestOne(name, false);
      if(ok){
        // Show completion state briefly then redirect
        if(progressBar) progressBar.style.width = '100%';
        if(progressPercent) progressPercent.textContent = '100%';
        if(progressText) progressText.textContent = 'Processing complete!';
        if(progressHint){
          progressHint.textContent = 'File uploaded. Redirecting...';
          progressHint.className = 'text-slate-400';
        }
        setTimeout(() => {
          window.location.href = "{{ url_for('admin.upload_tiles') }}?message="+encodeURIComponent(`Uploaded ${name}.`)+"&success=1";
        }, 400);
      } else {
        if(progressText) progressText.textContent = 'Processing failed';
        if(progressHint){
          progressHint.textContent = 'Failed to upload file. See server logs for details.';
          progressHint.className = 'text-red-600';
        }
        alert(`Failed to upload ${name}. See server logs for details.`);
        window.location.reload();
      }
    });
  });

  // Per-row delete button
  document.querySelectorAll('.delete-one').forEach(btn => {
    btn.addEventListener('click', async () => {
      const name = btn.dataset.file;
      if(!confirm(`Delete ${name}?`)) return;
      
      try {
        const resp = await fetch("{{ url_for('admin.upload_tiles_delete') }}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'fetch'
          },
          body: JSON.stringify({ files: [name] })
        });
        
        if(resp.ok) {
          const data = await resp.json();
          if(data.deleted > 0) {
            // Remove the tile from DOM without full reload for better UX
            const tile = btn.closest('.tile-preview');
            if(tile) {
              tile.style.opacity = '0';
              tile.style.transition = 'opacity 0.3s';
              setTimeout(() => {
                tile.remove();
                updateCount();
                // Update tiles array
                const idx = tiles.indexOf(tile);
                if(idx > -1) tiles.splice(idx, 1);
              }, 300);
            }
          } else {
            alert('Failed to delete file.');
          }
        } else {
          alert('Delete request failed.');
        }
      } catch(error) {
        alert('Error deleting file: ' + error.message);
      }
    });
  });

  if(uploadSelectedBtn){
    uploadSelectedBtn.addEventListener('click', async ()=>{
      const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
      // Compute quick summary from each row's data-exists flag
      let overwrite = 0, fresh = 0;
      for(const cb of boxes){
        const row = cb.closest('.tile-preview');
        const existsHint = row && row.dataset.exists === '1';
        if(existsHint){ overwrite++; } else { fresh++; }
      }
      const proceed = confirm(`You're about to upload ${boxes.length} file${boxes.length===1?'':'s'}:\n\n`+
        `• ${fresh} new\n`+
        `• ${overwrite} overwrite`+
        `\n\nContinue?`);
      if(!proceed) return;
      
      // Show progress bar
      const progressContainer = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressPercent = document.getElementById('progressPercent');
      const progressPhase = document.getElementById('progressPhase');
      const progressFileCount = document.getElementById('progressFileCount');
      const progressFileName = document.getElementById('progressFileName');
      const progressHint = document.getElementById('progressHint');
      const currentFileNum = document.getElementById('currentFileNum');
      const totalFileNum = document.getElementById('totalFileNum');
      
      if(progressContainer) {
        progressContainer.classList.remove('hidden');
        try { progressContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(_e) {}
        progressBar.style.width = '0%';
        progressPercent.textContent = '0%';
        progressText.textContent = `Processing ${boxes.length} selected file${boxes.length === 1 ? '' : 's'}...`;
        if(progressPhase) {
          progressPhase.textContent = 'Processing';
          progressPhase.className = 'px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700';
        }
        if(progressFileCount) {
          progressFileCount.classList.remove('hidden');
          if(totalFileNum) totalFileNum.textContent = boxes.length;
          if(currentFileNum) currentFileNum.textContent = '0';
        }
        if(progressFileName) progressFileName.classList.add('hidden');
        if(progressHint) progressHint.textContent = 'Uploading temporary files to the main library...';
      }
      
  let allOk = true;
      const total = boxes.length;
      let completed = 0;
  const failed = [];
  const succeeded = [];
      
      for(const cb of boxes){
        const name = cb.dataset.file;
        const tile = cb.closest('.tile-preview');
        const webpageName = tile ? tile.dataset.title : name;
        
        // Show current file being processed
        if(currentFileNum) currentFileNum.textContent = (completed + 1).toString();
        if(progressFileName && webpageName) {
          progressFileName.classList.remove('hidden');
          progressFileName.textContent = webpageName;
          progressFileName.title = webpageName;
        }
        if(progressText) progressText.textContent = `Processing files...`;
        
        // We've already shown the summary confirmation; skip per-file confirm prompts
        const ok = await ingestOne(name, true);
        if(!ok){
          allOk = false;
          failed.push(name);
        } else {
          succeeded.push(name);
        }
        
        // Update progress
        completed++;
        const percent = Math.round((completed / total) * 100);
        if(progressBar) progressBar.style.width = percent + '%';
        if(progressPercent) progressPercent.textContent = percent + '%';
        
        // Small delay to show current file
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      // Final completion message
      if(progressText) progressText.textContent = 'Processing complete!';
      if(progressHint) {
        progressHint.textContent = 'All selected files processed. Redirecting...';
        progressHint.className = 'text-slate-400';
      }
      if(progressFileName) progressFileName.classList.add('hidden');
      
      // Show a brief summary report
      const summaryLines = [
        `Processed: ${total}`,
        `Succeeded: ${succeeded.length}`,
        `Failed: ${failed.length}`
      ];
      if(failed.length){
        const maxList = failed.slice(0, 10).map(n => `  • ${n}`).join('\n');
        summaryLines.push('\nFailed files (first 10):');
        summaryLines.push(maxList);
      }
      alert('Upload report:\n\n' + summaryLines.join('\n'));

      // Hide progress bar after a brief success display
      setTimeout(() => {
        if(progressContainer) progressContainer.classList.add('hidden');
      }, 600);

      if(allOk){
        window.location.href = "{{ url_for('admin.upload_tiles') }}?message="+encodeURIComponent('New files uploaded.')+"&success=1";
      } else {
        window.location.reload();
      }
    });
  }
  if(downloadSelected){
    downloadSelected.addEventListener('click', ()=>{
      const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
      // Trigger browser downloads sequentially
      for(const cb of boxes){
        const name = cb.dataset.file;
        const a = document.createElement('a');
        a.href = "{{ url_for('admin.upload_tiles_download', name='__NAME__') }}".replace('__NAME__', encodeURIComponent(name));
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
    });
  }
  deleteSelected.addEventListener('click', async ()=>{
    const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
    if(!confirm(`Delete ${boxes.length} selected temp file${boxes.length === 1 ? '' : 's'}?`)) return;
    
    // Collect filenames
    const filenames = boxes.map(cb => cb.dataset.file);
    
    // Send batch delete request
    try {
      const resp = await fetch("{{ url_for('admin.upload_tiles_delete') }}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'fetch'
        },
        body: JSON.stringify({ files: filenames })
      });
      
      if(resp.ok) {
        const data = await resp.json();
        if(data.deleted > 0) {
          window.location.href = "{{ url_for('admin.upload_tiles') }}?message=" + 
            encodeURIComponent(`Deleted ${data.deleted} file${data.deleted === 1 ? '' : 's'}.`) + "&success=1";
        } else {
          alert('Failed to delete files.');
          window.location.reload();
        }
      } else {
        alert('Delete request failed.');
        window.location.reload();
      }
    } catch(error) {
      alert('Error deleting files: ' + error.message);
      window.location.reload();
    }
  });

  // Replace functionality removed from UI as per requirements.

  // Validation details toggle
  window.toggleValidationDetails = function(fileName) {
    const detailsEl = document.getElementById('validation-' + fileName);
    if (detailsEl) {
      detailsEl.classList.toggle('hidden');
    }
  };

  // Toggle tile selection when clicking anywhere on the tile
  window.toggleTileSelection = function(tile, event) {
    // Don't toggle if clicking on buttons, links, or inputs
    const target = event.target;
    if (target.tagName === 'BUTTON' || target.tagName === 'A' || 
        target.tagName === 'INPUT' || target.closest('button') || 
        target.closest('a') || target.closest('form')) {
      return;
    }
    
    const checkbox = tile.querySelector('.row-check');
    if (checkbox) {
      checkbox.checked = !checkbox.checked;
      // Trigger change event to update button states
      checkbox.dispatchEvent(new Event('change', { bubbles: true }));
    }
  };

  // Initial
  document.addEventListener('change', (e)=>{
    if(e.target.classList && e.target.classList.contains('row-check')){
      updateUploadSelectedButton();
    }
  });
  updateUploadSelectedButton();
  filter();
})();
</script>
{% endblock %}

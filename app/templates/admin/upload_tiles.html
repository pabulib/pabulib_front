{% extends 'base.html' %}

{% block bodyClass %}admin{% endblock %}
{% block title %}Upload Tiles{% endblock %}

{% block body %}
{% include 'admin/_navbar.html' %}
<section class="max-w-7xl mx-auto px-4">
  <div class="flex gap-6 justify-center">
    <!-- Sidebar filters (left) to match admin dashboard/delete -->
    <aside class="hidden md:block w-64 shrink-0 mt-8">
      <div class="bg-white rounded-lg shadow-lg p-5 sticky top-24">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">Filters</h2>

        <div class="mb-2">
          <label for="filterStatus" class="block text-sm font-medium text-slate-700 mb-1">Status</label>
          <select id="filterStatus" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-800 focus:ring-2 focus:ring-indigo-500">
            <option value="">All files</option>
            <option value="new">New only</option>
            <option value="existing">Existing (overwrite)</option>
          </select>
        </div>

        <button id="filtersClear" type="button" class="mt-4 w-full px-3 py-2 text-sm rounded-md border border-slate-300 text-slate-600 hover:bg-slate-50">Clear filters</button>
      </div>
    </aside>

    <div class="w-full">
      <div class="w-full bg-white rounded-lg shadow-lg p-6 mt-8">
        <div class="flex items-baseline justify-between mb-4">
          <h1 class="text-3xl font-bold text-slate-800">Admin – Upload Tiles</h1>
          <span class="text-sm text-slate-500">{{ count or 0 }} PB files</span>
        </div>
  <p class="text-gray-600 mb-6">These are temporary uploads. You can upload them as new files or remove them from the temporary area.</p>

        <!-- Subtle legend -->
        <div class="text-xs text-slate-500 mb-4 flex items-center gap-3">
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-emerald-200 bg-emerald-100 text-emerald-800" title="Valid file">✓ Valid</span>
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-red-200 bg-red-100 text-red-800" title="Invalid file">✗ Invalid</span>
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-blue-200 bg-blue-50 text-blue-700" title="File will be uploaded as a new dataset">New</span>
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded border border-orange-200 bg-orange-50 text-orange-700" title="File will overwrite an existing dataset">Overwrite</span>
        </div>

        <!-- Toolbar: search + bulk actions (mirrors admin dashboard style) -->
        <div class="mb-4 flex items-start gap-6">
          <!-- Left group: search + x/x + select all -->
          <div class="flex items-center gap-4 flex-1 min-w-0">
            <div class="relative w-full max-w-xs">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 4.238 12.03l4.241 4.241a.75.75 0 1 0 1.06-1.06l-4.24-4.242A6.75 6.75 0 0 0 10.5 3.75Zm-5.25 6.75a5.25 5.25 0 1 1 10.5 0 5.25 5.25 0 0 1-10.5 0Z" clip-rule="evenodd"/></svg>
            </span>
            <input id="tmpSearch" type="text" placeholder="Search titles…" class="w-full pl-10 pr-10 py-2.5 rounded-md border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-800 placeholder-slate-400" />
            <button id="tmpSearchClear" type="button" class="hidden absolute inset-y-0 right-0 pr-3 text-slate-400 hover:text-slate-600" aria-label="Clear search">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12 2.25a9.75 9.75 0 1 0 0 19.5 9.75 9.75 0 0 0 0-19.5Zm-2.47 6.78a.75.75 0 0 1 1.06 0L12 10.44l1.41-1.41a.75.75 0 0 1 1.06 1.06L13.06 11.5l1.41 1.41a.75.75 0 1 1-1.06 1.06L12 12.56l-1.41 1.41a.75.75 0 0 1-1.06-1.06l1.41-1.41-1.41-1.41a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd"/></svg>
            </button>
          </div>
            <span id="tmpCount" class="text-sm text-slate-500 whitespace-nowrap"></span>
            <label class="inline-flex items-center gap-2 text-slate-700">
              <input id="tmpSelectAll" type="checkbox" class="w-4 h-4">
              <span>Select all</span>
            </label>
          </div>

          <!-- Right group: selected label (left) + stacked actions (right) -->
          <div class="shrink-0 flex items-center gap-3">
            <!-- Responsive action group: horizontal on sm+, stacked on xs -->
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-0">
              <div class="inline-flex rounded-md shadow-sm ring-1 ring-slate-300 overflow-hidden divide-y sm:divide-y-0 sm:divide-x divide-slate-200">
                <button id="uploadSelectedBtn" type="button" title="Upload selected" class="inline-flex items-center gap-2 px-3 py-2 bg-emerald-100 text-emerald-800 hover:bg-emerald-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 3a.75.75 0 0 1 .75.75V14a.75.75 0 0 1-1.5 0V3.75A.75.75 0 0 1 12 3Z"/><path d="M7.72 8.47a.75.75 0 0 1 1.06 0L12 11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-3.75 3.75a1.5 1.5 0 0 1-2.12 0L7.72 9.53a.75.75 0 0 1 0-1.06Z"/><path d="M6.75 18A3.75 3.75 0 0 1 10.5 14.25h3A3.75 3.75 0 0 1 17.25 18v1.5H6.75V18Z"/></svg>
                  <span id="uploadLabel" class="hidden sm:inline">Upload</span>
                </button>
                <button type="button" id="downloadSelected" title="Download selected" class="inline-flex items-center gap-2 px-3 py-2 bg-white text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 3.75a.75.75 0 0 1 .75.75v9.44l2.47-2.47a.75.75 0 1 1 1.06 1.06l-3.75 3.75a1.5 1.5 0 0 1-2.12 0L6.66 12.53a.75.75 0 0 1 1.06-1.06l2.53 2.53V4.5a.75.75 0 0 1 .75-.75Z"/><path d="M6.75 18A3.75 3.75 0 0 1 10.5 14.25h3A3.75 3.75 0 0 1 17.25 18v1.5H6.75V18Z"/></svg>
                  <span id="downloadLabel" class="hidden sm:inline">Download</span>
                </button>
                <button type="button" id="deleteSelected" title="Delete selected" class="inline-flex items-center gap-2 px-3 py-2 bg-red-100 text-red-800 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M9 3.75A1.5 1.5 0 0 1 10.5 2.25h3A1.5 1.5 0 0 1 15 3.75V4.5h3.75a.75.75 0 0 1 0 1.5H5.25a.75.75 0 0 1 0-1.5H9V3.75Z"/><path fill-rule="evenodd" d="M6.75 6.75h10.5l-.69 11.087A3 3 0 0 1 13.57 20.7H10.43a3 3 0 0 1-2.99-2.863L6.75 6.75Zm4.5 3a.75.75 0 0 0-1.5 0v6a.75.75 0 1 0 1.5 0v-6Zm3 0a.75.75 0 0 0-1.5 0v6a.75.75 0 1 0 1.5 0v-6Z" clip-rule="evenodd"/></svg>
                  <span id="deleteLabel" class="hidden sm:inline">Delete</span>
                </button>
              </div>
            </div>
          </div>
        </div>

          {% if message %}
          <div class="p-3 rounded-md text-sm {{ 'bg-green-50 text-green-700 border border-green-200' if success else 'bg-red-50 text-red-700 border border-red-200' }}">
            {{ message }}
          </div>
          {% endif %}

          {% if results %}
          <div class="mt-3 space-y-2">
            {% for r in results %}
            <div class="p-2 rounded-md text-xs border {{ 'bg-emerald-50 border-emerald-200' if r.ok else 'bg-red-50 border-red-200' }}">
              <div class="flex items-start gap-2">
                <span class="{{ 'text-emerald-700' if r.ok else 'text-red-700' }}">{{ '✓' if r.ok else '✗' }}</span>
                <div class="flex-1">
                  <span class="font-medium">{{ r.name }}</span>: {{ r.msg }}
                  {% if r.validation %}
                  <div class="mt-1 {{ 'text-emerald-700' if r.validation.valid else ('text-orange-600' if r.validation.error_message else 'text-red-700') }}">
                    {{ r.validation_summary }}
                  </div>
                  {% if r.validation.errors %}
                  <div class="mt-1 text-red-600">
                    <div class="font-medium">Errors:</div>
                    <ul class="list-disc list-inside ml-2">
                      {% for error_type, instances in r.validation.errors.items() %}
                        {% for instance_id, message in instances.items() %}
                          <li>{{ error_type }}: {{ message }}</li>
                        {% endfor %}
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                  {% if r.validation.warnings %}
                  <div class="mt-1 text-orange-600">
                    <div class="font-medium">Warnings:</div>
                    <ul class="list-disc list-inside ml-2">
                      {% for warning_type, instances in r.validation.warnings.items() %}
                        {% for instance_id, message in instances.items() %}
                          <li>{{ warning_type }}: {{ message }}</li>
                        {% endfor %}
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          <div id="dropzone" class="border-2 border-dashed border-slate-300 rounded-md p-8 text-center text-slate-500 hover:border-slate-400 cursor-pointer">
            <div class="text-lg font-medium mb-1">Add files</div>
            <div class="text-sm">Drag & drop .pb files here, or click to choose</div>
            <input id="files" name="files" type="file" accept=".pb" multiple class="hidden" />
          </div>
        </div>

        <div class="mt-6 space-y-4" id="tilesContainer">
    {% for t in tiles %}
    <section class="rounded-lg shadow p-4 tile-preview {{ 'bg-red-100 ring-2 ring-red-200' if not t.validation.valid else 'bg-emerald-100 ring-2 ring-emerald-200' }}"
      data-title="{{ t.title|e }}"
      data-desc="{{ t.description|e }}"
      data-file="{{ t.file_name|e }}"
      data-exists="{{ '1' if t.exists_conflict else '' }}"
      data-valid="{{ '1' if t.validation.valid else '0' }}"
    >
      <div class="flex items-start gap-4">
        <input class="row-check mt-1.5" type="checkbox" data-file="{{ t.file_name|e }}" />
        
        {# Main tile info #}
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-slate-800 truncate">{{ t.title }}</h2>
            {% if t.exists_conflict %}
              <span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700 border border-orange-200">Overwrite</span>
            {% else %}
              <span class="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700 border border-blue-200">New</span>
            {% endif %}
            {% if t.experimental %}
              <span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700">Experimental</span>
            {% endif %}
            {% if t.fully_funded %}
              <span class="text-xs px-2 py-0.5 rounded bg-emerald-100 text-emerald-700">Fully funded</span>
            {% endif %}
          </div>
          <div class="text-slate-600 text-sm mt-1">{{ t.description }}</div>
          <div class="text-slate-500 text-xs mt-1 font-mono truncate" title="{{ t.file_name }}">{{ t.file_name }}</div>
          <div class="grid grid-cols-5 gap-3 mt-3 text-sm">
            <div class="text-slate-500"># votes<br><span class="text-slate-800">{{ t.num_votes }}</span></div>
            <div class="text-slate-500"># projects<br><span class="text-slate-800">{{ t.num_projects }}</span></div>
            <div class="text-slate-500">Budget<br><span class="text-slate-800">{{ t.budget }}</span></div>
            <div class="text-slate-500">Vote type<br><span class="text-slate-800">{{ t.vote_type }}</span></div>
            <div class="text-slate-500">Vote length<br><span class="text-slate-800">{{ t.vote_length }}</span></div>
          </div>
        </div>
        
        {# Validation Report Column #}
        {% if t.validation %}
        <div class="w-64 shrink-0 border-l border-slate-200 pl-4">
          <div class="text-xs font-medium text-slate-600 mb-2">Validation Report</div>
          <div class="flex items-start gap-2 mb-2">
            <span class="text-xl {{ 'text-emerald-600' if t.validation.valid else ('text-orange-600' if t.validation.error_message else 'text-red-600') }}">
              {{ '✓' if t.validation.valid else ('⚠' if t.validation.error_message else '✗') }}
            </span>
            <div class="flex-1 text-xs">
              <div class="{{ 'text-emerald-700 font-medium' if t.validation.valid else ('text-orange-700' if t.validation.error_message else 'text-red-700 font-medium') }}">
                {% if t.validation.valid %}
                  Valid file
                {% elif t.validation.error_message %}
                  {{ t.validation.error_message }}
                {% else %}
                  Invalid file
                {% endif %}
              </div>
              {% if t.error_count > 0 %}
              <div class="text-red-700 mt-1">{{ t.error_count }} error{{ 's' if t.error_count != 1 else '' }}</div>
              {% endif %}
              {% if t.warning_count > 0 %}
              <div class="text-orange-700 mt-1">{{ t.warning_count }} warning{{ 's' if t.warning_count != 1 else '' }}</div>
              {% endif %}
            </div>
          </div>
          
          {% if t.validation.errors or t.validation.warnings %}
          <button type="button" class="text-xs text-indigo-600 hover:text-indigo-800 underline" onclick="toggleValidationDetails('{{ t.file_name|e }}')">
            Show details
          </button>
          
          {# Detailed validation errors/warnings (initially hidden) #}
          <div id="validation-{{ t.file_name|e }}" class="hidden mt-2 p-2 bg-slate-50 rounded text-xs space-y-2 max-h-48 overflow-y-auto">
            {% if t.validation.errors %}
            <div>
              <div class="font-semibold text-red-700 mb-1">Errors:</div>
              <ul class="list-disc list-inside space-y-1 text-red-600">
                {% for error_type, instances in t.validation.errors.items() %}
                  {% for instance_id, message in instances.items() %}
                    <li><span class="font-medium">{{ error_type }}:</span> {{ message }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            
            {% if t.validation.warnings %}
            <div>
              <div class="font-semibold text-orange-700 mb-1">Warnings:</div>
              <ul class="list-disc list-inside space-y-1 text-orange-600">
                {% for warning_type, instances in t.validation.warnings.items() %}
                  {% for instance_id, message in instances.items() %}
                    <li><span class="font-medium">{{ warning_type }}:</span> {{ message }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endif %}
        
        {# Action buttons column #}
        <div class="flex flex-col items-center gap-2 ml-2">
          <a class="p-2 rounded-md border border-slate-300 hover:bg-slate-50" title="Download" href="{{ url_for('admin.upload_tiles_download', name=t.file_name) }}">⬇</a>
          <div class="flex flex-col items-center gap-1">
            <button class="p-2 rounded-md border border-slate-300 hover:bg-slate-50 ingest-one" data-file="{{ t.file_name|e }}" title="Upload" type="button">⤴</button>
            {% if t.exists_conflict %}
              <span class="text-[10px] text-orange-600" title="A current dataset exists; ingest will overwrite.">overwrite</span>
            {% endif %}
          </div>
          <form method="post" action="{{ url_for('admin.upload_tiles_delete') }}" onsubmit="return confirm('Delete this temp file?')">
            <input type="hidden" name="name" value="{{ t.file_name }}" />
            <button class="p-2 rounded-md border border-slate-300 hover:bg-slate-50 text-red-700" title="Delete" type="submit">🗑</button>
          </form>
        </div>
      </div>
    </section>
    {% endfor %}
    {% if not tiles or tiles|length == 0 %}
      <div class="text-center text-slate-500">No temporary uploads yet.</div>
    {% endif %}
  </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('files');
  const tiles = Array.from(document.querySelectorAll('.tile-preview'));
  const countEl = document.getElementById('tmpCount');
  const selectAll = document.getElementById('tmpSelectAll');
  const search = document.getElementById('tmpSearch');
  const searchClear = document.getElementById('tmpSearchClear');
  const statusSel = document.getElementById('filterStatus');
  const clearFilters = document.getElementById('filtersClear');
  const uploadSelectedBtn = document.getElementById('uploadSelectedBtn');
  const deleteSelected = document.getElementById('deleteSelected');
  const downloadSelected = document.getElementById('downloadSelected');
  const uploadLabel = document.getElementById('uploadLabel');
  const downloadLabel = document.getElementById('downloadLabel');
  const deleteLabel = document.getElementById('deleteLabel');
  // Removed explicit Selected: X label from UI; keep internal count only if needed.
  // const replaceWithSelected = document.getElementById('replaceWithSelected');
  const total = tiles.length;

  function updateCount(){
    const visible = tiles.filter(t => t.style.display !== 'none').length;
    if(countEl) countEl.textContent = `${visible} / ${total}`;
  }

  function filter(){
    const q = (search.value || '').toLowerCase().trim();
    const fs = (statusSel && statusSel.value) || '';
    tiles.forEach(t => {
      const title = (t.dataset.title || '').toLowerCase();
      const desc = (t.dataset.desc || '').toLowerCase();
      const file = (t.dataset.file || '').toLowerCase();
      const textMatch = !q || title.includes(q) || desc.includes(q) || file.includes(q);
      const exists = t.dataset.exists === '1';
      const statusMatch = !fs || (fs === 'existing' ? exists : !exists);
      const match = textMatch && statusMatch;
      t.style.display = match ? '' : 'none';
    });
    updateCount();
  }

  function checkedBoxes(){
    return Array.from(document.querySelectorAll('.row-check')).filter(cb => cb.checked && cb.closest('.tile-preview').style.display !== 'none');
  }

  if(search){
    let tid=null; search.addEventListener('input', ()=>{ if(tid) cancelAnimationFrame(tid); tid=requestAnimationFrame(()=>{ filter(); const has= (search.value||'').length>0; if(searchClear) searchClear.classList.toggle('hidden', !has); }); });
  }
  if(searchClear){
    searchClear.addEventListener('click', ()=>{ search.value=''; filter(); search.focus(); searchClear.classList.add('hidden'); });
  }
  if(statusSel){
    statusSel.addEventListener('change', ()=>{ filter(); });
  }
  if(clearFilters){
    clearFilters.addEventListener('click', ()=>{ if(statusSel) statusSel.value=''; filter(); });
  }
  if(selectAll){
    selectAll.addEventListener('change', ()=>{
      tiles.forEach(t => { if(t.style.display !== 'none'){ const cb=t.querySelector('.row-check'); if(cb) cb.checked = selectAll.checked; }});
      updateUploadSelectedButton();
    });
  }

  // Dropzone
  function highlight(on){ dropzone.classList.toggle('ring-2', on); dropzone.classList.toggle('ring-indigo-500', on); }
  ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); highlight(true);}));
  ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); highlight(false);}));
  dropzone.addEventListener('click', ()=> fileInput && fileInput.click());
  dropzone.addEventListener('drop', e => {
    const files = Array.from(e.dataTransfer.files || []);
    if(files.length) uploadFiles(files);
  });
  fileInput && fileInput.addEventListener('change', e => {
    const files = Array.from(fileInput.files || []);
    if(files.length) uploadFiles(files);
  });

  async function uploadFiles(files){
    // Note: Server will check for webpage_name duplicates based on META data
    // First try uploading without force_replace to detect duplicates
    let fd = new FormData();
    files.forEach(f => fd.append('files', f));
    
    let resp = await fetch("{{ url_for('admin.upload_tiles') }}", { method: 'POST', body: fd });
    
    if(resp.ok){
      // Check if there were any duplicate webpage_name rejections in the response
      const html = await resp.text();
      const hasDuplicateWarning = html.includes('duplicate webpage_name') || html.includes('Duplicate detected');
      
      if(hasDuplicateWarning){
        // Extract webpage_names from the error messages
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const webpageNames = [];
        
        // Look for all error messages containing webpage_name info
        const errorDivs = doc.querySelectorAll('.text-red-700, .text-red-600');
        errorDivs.forEach(div => {
          const text = div.textContent;
          const match = text.match(/webpage_name '([^']+)'/);
          if(match && match[1] && !webpageNames.includes(match[1])){
            webpageNames.push(match[1]);
          }
        });
        
        // Build a nice confirmation message with the list of webpage_names
        let confirmMsg = `Some files were rejected because they have the same webpage_name (based on META data: country, unit, instance, subunit) as existing temp files.\n\n`;
        if(webpageNames.length > 0){
          confirmMsg += `The following webpage_names already exist:\n`;
          webpageNames.forEach(name => {
            confirmMsg += `  • ${name}\n`;
          });
          confirmMsg += `\n`;
        }
        confirmMsg += `Do you want to REPLACE the existing temp files with the new ones?`;
        
        const proceed = confirm(confirmMsg);
        
        if(proceed){
          // Re-upload with force_replace flag
          fd = new FormData();
          files.forEach(f => fd.append('files', f));
          fd.append('force_replace', '1');
          resp = await fetch("{{ url_for('admin.upload_tiles') }}", { method: 'POST', body: fd });
        }
      }
      
      // Reload to render server-side parsed previews and messages
      window.location.reload();
    } else {
      alert('Upload failed');
    }
  }

  // Upload selected button label updater
  function updateUploadSelectedButton(){
    const boxes = checkedBoxes();
    const n = boxes.length;
    if(uploadSelectedBtn){ uploadSelectedBtn.disabled = n === 0; }
    if(deleteSelected){ deleteSelected.disabled = n === 0; }
    if(downloadSelected){ downloadSelected.disabled = n === 0; }
    if(uploadLabel){ uploadLabel.textContent = n > 0 ? `Upload ${n}` : 'Upload'; }
    if(deleteLabel){ deleteLabel.textContent = n > 0 ? `Delete ${n}` : 'Delete'; }
    if(downloadLabel){ downloadLabel.textContent = n > 0 ? `Download ${n}` : 'Download'; }
    // No external label to update
  }

  async function postAction(url, name){
    const body = new URLSearchParams(); body.set('name', name);
    const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' }, body: body.toString() });
    return resp;
  }

  // Upload a single temp file. When called from bulk flow, skipConfirm=true to avoid
  // any additional per-file confirmations; we rely on the single summary confirmation.
  async function ingestOne(name, skipConfirm){
    if(!name) return;
    // Optional pre-check (only when not already confirmed at batch level)
    if(!skipConfirm){
      let proceed = true;
      try{
        const chk = await fetch("{{ url_for('admin.upload_tiles_check') }}?name="+encodeURIComponent(name), { headers: { 'X-Requested-With': 'fetch' }});
        if(chk.ok){ const data = await chk.json(); if(data.exists){ proceed = confirm(`A current dataset exists for ${name}. Overwrite?`); } }
      }catch(_e){ /* ignore */ }
      if(!proceed) return;
    }
    const params = new URLSearchParams(); params.set('name', name); params.set('confirm', '1');
    const resp = await fetch("{{ url_for('admin.upload_tiles_ingest') }}", { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' }, body: params.toString() });
    if(!resp.ok){
      // If server reports conflict (409) but we already confirmed at batch level, don't prompt again.
      if(resp.status !== 409 || !skipConfirm){
        try { const data = await resp.json(); alert(`Failed to upload ${name}: ${data.error || data.message || resp.status}`); } catch(_e) { alert(`Failed to upload ${name}.`); }
        return false;
      }
    }
    return true;
  }
  // Per-row ingest button
  document.querySelectorAll('.ingest-one').forEach(btn => {
    btn.addEventListener('click', async () => {
      const name = btn.dataset.file;
      // Per-row ingest keeps its own overwrite confirmation (skipConfirm=false)
      const ok = await ingestOne(name, false);
      if(ok){
        window.location.href = "{{ url_for('admin.upload_tiles') }}?message="+encodeURIComponent(`Uploaded ${name}.`)+"&success=1";
      } else {
        alert(`Failed to upload ${name}. See server logs for details.`);
        window.location.reload();
      }
    });
  });

  if(uploadSelectedBtn){
    uploadSelectedBtn.addEventListener('click', async ()=>{
      const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
      // Compute quick summary from each row's data-exists flag
      let overwrite = 0, fresh = 0;
      for(const cb of boxes){
        const row = cb.closest('.tile-preview');
        const existsHint = row && row.dataset.exists === '1';
        if(existsHint){ overwrite++; } else { fresh++; }
      }
      const proceed = confirm(`You're about to upload ${boxes.length} file${boxes.length===1?'':'s'}:\n\n`+
        `• ${fresh} new\n`+
        `• ${overwrite} overwrite`+
        `\n\nContinue?`);
      if(!proceed) return;
      let allOk = true;
      for(const cb of boxes){
        const name = cb.dataset.file;
        // We've already shown the summary confirmation; skip per-file confirm prompts
        const ok = await ingestOne(name, true);
        if(!ok) allOk = false;
      }
      if(allOk){
        window.location.href = "{{ url_for('admin.upload_tiles') }}?message="+encodeURIComponent('New files uploaded.')+"&success=1";
      } else {
        alert('Some uploads failed. See server logs for details.');
        window.location.reload();
      }
    });
  }
  if(downloadSelected){
    downloadSelected.addEventListener('click', ()=>{
      const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
      // Trigger browser downloads sequentially
      for(const cb of boxes){
        const name = cb.dataset.file;
        const a = document.createElement('a');
        a.href = "{{ url_for('admin.upload_tiles_download', name='__NAME__') }}".replace('__NAME__', encodeURIComponent(name));
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
    });
  }
  deleteSelected.addEventListener('click', async ()=>{
    const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
    if(!confirm('Delete selected temp files?')) return;
  for(const cb of boxes){ const name = cb.dataset.file; await postAction("{{ url_for('admin.upload_tiles_delete') }}", name); }
    window.location.reload();
  });

  // Replace functionality removed from UI as per requirements.

  // Validation details toggle
  window.toggleValidationDetails = function(fileName) {
    const detailsEl = document.getElementById('validation-' + fileName);
    if (detailsEl) {
      detailsEl.classList.toggle('hidden');
    }
  };

  // Initial
  document.addEventListener('change', (e)=>{
    if(e.target.classList && e.target.classList.contains('row-check')){
      updateUploadSelectedButton();
    }
  });
  updateUploadSelectedButton();
  filter();
})();
</script>
{% endblock %}

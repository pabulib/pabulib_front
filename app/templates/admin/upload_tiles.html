{% extends 'base.html' %}

{% block bodyClass %}admin{% endblock %}
{% block title %}Upload Tiles{% endblock %}

{% block body %}
{% include 'admin/_navbar.html' %}
<section class="max-w-5xl mx-auto px-4">
  <div class="w-full bg-white rounded-lg shadow-lg p-6 mt-8">
    <div class="flex flex-col gap-4">
      <div class="flex items-center gap-3">
        <input id="tmpSearch" type="text" placeholder="Search..." class="flex-1 px-3 py-2 rounded-md border border-slate-300 focus:ring-2 focus:ring-indigo-500" />
        <label class="inline-flex items-center gap-2 text-slate-700">
          <input id="tmpSelectAll" type="checkbox" class="w-4 h-4">
          <span>Select all</span>
        </label>
        <div class="ml-auto text-slate-600"><span id="tmpCount">{{ count or 0 }}</span> PBs found</div>
        <div class="relative">
          <button id="tmpSelectedBtn" type="button" class="px-3 py-2 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-50">Selected</button>
          <div id="tmpSelectedMenu" class="hidden absolute right-0 mt-2 w-44 bg-white border border-slate-200 rounded-md shadow-lg z-10">
            <button type="button" id="ingestSelected" class="w-full text-left px-3 py-2 text-sm hover:bg-slate-50">Ingest selected</button>
            <button type="button" id="deleteSelected" class="w-full text-left px-3 py-2 text-sm hover:bg-slate-50">Delete selected</button>
          </div>
        </div>
      </div>

      {% if message %}
      <div class="p-3 rounded-md text-sm {{ 'bg-green-50 text-green-700 border border-green-200' if success else 'bg-red-50 text-red-700 border border-red-200' }}">
        {{ message }}
      </div>
      {% endif %}

      <div id="dropzone" class="border-2 border-dashed border-slate-300 rounded-md p-8 text-center text-slate-500 hover:border-slate-400 cursor-pointer">
        <div class="text-lg font-medium mb-1">Add files</div>
        <div class="text-sm">Drag & drop .pb files here, or click to choose</div>
        <input id="files" name="files" type="file" accept=".pb" multiple class="hidden" />
      </div>
    </div>
  </div>

  <div class="mt-6 space-y-4" id="tilesContainer">
    {% for t in tiles %}
    <section class="bg-white rounded-lg shadow p-4 tile-preview"
      data-title="{{ t.title|e }}"
      data-desc="{{ t.description|e }}"
      data-file="{{ t.file_name|e }}"
    >
      <div class="flex items-start gap-3">
        <input class="row-check mt-1.5" type="checkbox" data-file="{{ t.file_name|e }}" />
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-slate-800 truncate">{{ t.title }}</h2>
            {% if t.experimental %}
              <span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700">Experimental</span>
            {% endif %}
            {% if t.fully_funded %}
              <span class="text-xs px-2 py-0.5 rounded bg-emerald-100 text-emerald-700">Fully funded</span>
            {% endif %}
          </div>
          <div class="text-slate-600 text-sm mt-1">{{ t.description }}</div>
          <div class="grid grid-cols-6 gap-3 mt-3 text-sm">
            <div class="text-slate-500"># votes<br><span class="text-slate-800">{{ t.num_votes }}</span></div>
            <div class="text-slate-500"># projects<br><span class="text-slate-800">{{ t.num_projects }}</span></div>
            <div class="text-slate-500">Budget<br><span class="text-slate-800">{{ t.budget }}</span></div>
            <div class="text-slate-500">Vote type<br><span class="text-slate-800">{{ t.vote_type }}</span></div>
            <div class="text-slate-500">Vote length<br><span class="text-slate-800">{{ t.vote_length }}</span></div>
            <div class="text-slate-500">File<br><span class="text-slate-800 font-mono truncate block" title="{{ t.file_name }}">{{ t.file_name }}</span></div>
          </div>
        </div>
        <div class="flex flex-col items-center gap-2 ml-2">
          <a class="p-2 rounded-md border border-slate-300 hover:bg-slate-50" title="Download" href="{{ url_for('admin.upload_tiles_download', name=t.file_name) }}">â¬‡</a>
          <button class="p-2 rounded-md border border-slate-300 hover:bg-slate-50 ingest-one" data-file="{{ t.file_name|e }}" title="Ingest" type="button">â¤´</button>
          <form method="post" action="{{ url_for('admin.upload_tiles_delete') }}" onsubmit="return confirm('Delete this temp file?')">
            <input type="hidden" name="name" value="{{ t.file_name }}" />
            <button class="p-2 rounded-md border border-slate-300 hover:bg-slate-50 text-red-700" title="Delete" type="submit">ðŸ—‘</button>
          </form>
        </div>
      </div>
    </section>
    {% endfor %}
    {% if not tiles or tiles|length == 0 %}
      <div class="text-center text-slate-500">No temporary uploads yet.</div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('files');
  const tiles = Array.from(document.querySelectorAll('.tile-preview'));
  const countEl = document.getElementById('tmpCount');
  const selectAll = document.getElementById('tmpSelectAll');
  const search = document.getElementById('tmpSearch');
  const selectedBtn = document.getElementById('tmpSelectedBtn');
  const selectedMenu = document.getElementById('tmpSelectedMenu');
  const ingestSelected = document.getElementById('ingestSelected');
  const deleteSelected = document.getElementById('deleteSelected');

  function updateCount(){
    const visible = tiles.filter(t => t.style.display !== 'none').length;
    if(countEl) countEl.textContent = String(visible);
  }

  function filter(){
    const q = (search.value || '').toLowerCase().trim();
    tiles.forEach(t => {
      const title = (t.dataset.title || '').toLowerCase();
      const desc = (t.dataset.desc || '').toLowerCase();
      const file = (t.dataset.file || '').toLowerCase();
      const match = !q || title.includes(q) || desc.includes(q) || file.includes(q);
      t.style.display = match ? '' : 'none';
    });
    updateCount();
  }

  function checkedBoxes(){
    return Array.from(document.querySelectorAll('.row-check')).filter(cb => cb.checked && cb.closest('.tile-preview').style.display !== 'none');
  }

  if(search){
    let tid=null; search.addEventListener('input', ()=>{ if(tid) cancelAnimationFrame(tid); tid=requestAnimationFrame(filter); });
  }
  if(selectAll){
    selectAll.addEventListener('change', ()=>{
      tiles.forEach(t => { if(t.style.display !== 'none'){ const cb=t.querySelector('.row-check'); if(cb) cb.checked = selectAll.checked; }});
    });
  }

  // Dropzone
  function highlight(on){ dropzone.classList.toggle('ring-2', on); dropzone.classList.toggle('ring-indigo-500', on); }
  ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); highlight(true);}));
  ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation(); highlight(false);}));
  dropzone.addEventListener('click', ()=> fileInput && fileInput.click());
  dropzone.addEventListener('drop', e => {
    const files = Array.from(e.dataTransfer.files || []);
    if(files.length) uploadFiles(files);
  });
  fileInput && fileInput.addEventListener('change', e => {
    const files = Array.from(fileInput.files || []);
    if(files.length) uploadFiles(files);
  });

  async function uploadFiles(files){
    const fd = new FormData();
    files.forEach(f => fd.append('files', f));
  const resp = await fetch("{{ url_for('admin.upload_tiles') }}", { method: 'POST', body: fd });
    // Reload to render server-side parsed previews and messages
    if(resp.ok){ window.location.reload(); } else { alert('Upload failed'); }
  }

  // Selected menu
  selectedBtn.addEventListener('click', ()=>{ selectedMenu.classList.toggle('hidden'); });
  window.addEventListener('click', (e)=>{ if(!selectedBtn.contains(e.target) && !selectedMenu.contains(e.target)) selectedMenu.classList.add('hidden'); });

  async function postAction(url, name){
    const body = new URLSearchParams(); body.set('name', name);
    const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' }, body: body.toString() });
    return resp;
  }

  async function ingestOne(name){
    if(!name) return;
    // Check potential overwrite
    let proceed = true;
    try{
      const chk = await fetch("{{ url_for('admin.upload_tiles_check') }}?name="+encodeURIComponent(name), { headers: { 'X-Requested-With': 'fetch' }});
      if(chk.ok){ const data = await chk.json(); if(data.exists){ proceed = confirm(`A current dataset exists for ${name}. Overwrite?`); } }
    }catch(_e){ /* ignore */ }
    if(!proceed) return;
    const params = new URLSearchParams(); params.set('name', name); params.set('confirm', '1');
    const resp = await fetch("{{ url_for('admin.upload_tiles_ingest') }}", { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' }, body: params.toString() });
    if(!resp.ok){
      if(resp.status === 409){
        const ask = confirm(`A current dataset exists for ${name}. Overwrite?`);
        if(ask){
          const retryParams = new URLSearchParams(); retryParams.set('name', name); retryParams.set('confirm', '1');
          const retry = await fetch("{{ url_for('admin.upload_tiles_ingest') }}", { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' }, body: retryParams.toString() });
          if(!retry.ok){
            try { const data = await retry.json(); alert(`Failed to ingest ${name}: ${data.error || data.message || retry.status}`); } catch(_e) { alert(`Failed to ingest ${name}.`); }
            return false;
          }
        } else { return; }
      } else {
        try { const data = await resp.json(); alert(`Failed to ingest ${name}: ${data.error || data.message || resp.status}`); } catch(_e) { alert(`Failed to ingest ${name}.`); }
        return false;
      }
    }
    return true;
  }
  // Per-row ingest button
  document.querySelectorAll('.ingest-one').forEach(btn => {
    btn.addEventListener('click', async () => {
      const name = btn.dataset.file;
      const ok = await ingestOne(name);
      if(ok){
        window.location.href = "{{ url_for('admin.upload_tiles') }}?message="+encodeURIComponent(`Ingested ${name}.`)+"&success=1";
      } else {
        alert(`Failed to ingest ${name}. See server logs for details.`);
        window.location.reload();
      }
    });
  });

  ingestSelected.addEventListener('click', async ()=>{
    const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
    let allOk = true;
    for(const cb of boxes){
      const name = cb.dataset.file;
      const ok = await ingestOne(name);
      if(!ok) allOk = false;
    }
    if(allOk){
      window.location.href = "{{ url_for('admin.upload_tiles') }}?message="+encodeURIComponent('New files ingested.')+"&success=1";
    } else {
      alert('Some ingests failed. See server logs for details.');
      window.location.reload();
    }
  });
  deleteSelected.addEventListener('click', async ()=>{
    const boxes = checkedBoxes(); if(!boxes.length){ alert('No files selected'); return; }
    if(!confirm('Delete selected temp files?')) return;
  for(const cb of boxes){ const name = cb.dataset.file; await postAction("{{ url_for('admin.upload_tiles_delete') }}", name); }
    window.location.reload();
  });

  // Initial
  filter();
})();
</script>
{% endblock %}

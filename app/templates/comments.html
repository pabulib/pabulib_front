{% extends 'base.html' %}

{% block bodyClass %}comments{% endblock %}
{% block title %}Pabulib – Comments{% endblock %}

{% block body %}
<div class="container py-3">
  <h1 class="mb-3">Comments</h1>
  <p class="text-muted">Parsed from META key <code>comment</code> using pattern <code>#n:</code> segments. Showing how many PB files share each comment.</p>

  <div class="table-responsive">
    <table class="table table-striped align-middle comments-table">
      <colgroup>
        <col style="width:45%">
        <col style="width:10%">
        <col style="width:45%">
      </colgroup>
      <thead class="table-light">
        <tr>
          <th>Comment</th>
          <th># files</th>
          <th>
            <div style="display:flex;align-items:center;gap:8px">
              <span>Files</span>
              <label style="display:flex;align-items:center;gap:6px;font-weight:400;font-size:12px;color:#6c757d">
                Group by
                <select id="groupMode" style="margin:0;border:1px solid #dee2e6;border-radius:6px;padding:2px 6px;font-size:12px;color:#495057;background:#fff">
                  <option value="none">None</option>
                  <option value="country">Country</option>
                  <option value="country_unit">Country + Unit</option>
                </select>
              </label>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        {% for comment, count, files in rows %}
        <tr>
          <td class="comment-cell">{{ comment }}</td>
          <td><span class="badge text-bg-secondary">{{ count }}</span></td>
          <td>
            {% set preview = files[:5] %}
            <div class="files-cell">
        <div class="file-list"
          data-files='{{ files|tojson|e }}'
          data-groups-country='{{ (groups_by_comment_country.get(comment) or [])|tojson|e }}'
          data-groups-country-unit='{{ (groups_by_comment_country_unit.get(comment) or [])|tojson|e }}'
          data-expanded="0"></div>
              {% if files|length > preview|length %}
                <button type="button" class="btn btn-sm btn-outline-primary mt-1 btn-expand" aria-label="Show all files" aria-expanded="false">+</button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
// Expand/collapse behavior for files list (+ to expand, − to collapse)
(function(){
  const PREVIEW_COUNT = 5;
  function getGroupMode(){ const el = document.getElementById('groupMode'); return el ? el.value : 'none'; }
  function renderFilesFlat(container, files, expanded){
    if(expanded){
      container.innerHTML = files.map(f => `<span class="file-item">${f}</span>`).join('');
      container.dataset.expanded = '1';
    } else {
      const rest = Math.max(files.length - PREVIEW_COUNT, 0);
      const preview = files.slice(0, PREVIEW_COUNT).map(f => `<span class="file-item">${f}</span>`).join('');
      const more = rest > 0 ? `<span class="more-count text-muted">+ ${rest} more</span>` : '';
      container.innerHTML = preview + more;
      container.dataset.expanded = '0';
    }
  }
  function renderFilesGrouped(container, groups, expanded){
    // groups: [{label, count, files}]
    let html = '';
    const toRender = expanded ? groups : groups.slice(0, 3);
    toRender.forEach(g => {
      const list = (expanded ? g.files : g.files.slice(0, Math.max(2, Math.ceil(PREVIEW_COUNT/Math.max(1, toRender.length)))));
      html += `<div class="group">
        <div class="group-head"><span class="group-label">${g.label || '—'}</span><span class="group-count">${g.count}</span></div>
        <div class="group-files">${list.map(f=>`<span class="file-item">${f}</span>`).join('')}</div>
      </div>`;
    });
    if(!expanded){
      const restGroups = Math.max(groups.length - toRender.length, 0);
      if(restGroups > 0){
        html += `<span class="more-count text-muted">+ ${restGroups} more groups</span>`;
      }
    }
    container.innerHTML = html;
    container.dataset.expanded = expanded ? '1' : '0';
  }
  function render(container, expanded){
    let files = [], groups = [];
    try{ files = JSON.parse(container.getAttribute('data-files')||'[]') || []; }catch(e){ files=[]; }
    const mode = getGroupMode();
    if(mode === 'country'){
      try{ groups = JSON.parse(container.getAttribute('data-groups-country')||'[]') || []; }catch(e){ groups=[]; }
    }else if(mode === 'country_unit'){
      try{ groups = JSON.parse(container.getAttribute('data-groups-country-unit')||'[]') || []; }catch(e){ groups=[]; }
    }else{
      groups = [];
    }
    const grouped = (mode !== 'none') && groups && groups.length;
    if(grouped){
      renderFilesGrouped(container, groups, expanded);
    } else {
      renderFilesFlat(container, files, expanded);
    }
  }
  // Initial render for all rows
  document.querySelectorAll('.file-list').forEach(el => render(el, false));
  // Toggle handler
  addEventListener('change', (e)=>{
    if(e.target && e.target.id === 'groupMode'){
      document.querySelectorAll('.file-list').forEach(el => {
        const expanded = el.dataset.expanded === '1';
        render(el, expanded);
      });
    }
  });
  addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-expand');
    if (!btn) return;
    const wrap = btn.closest('.files-cell'); // robust parent lookup
    const container = wrap && wrap.querySelector('.file-list');
    if (!container) return;
    const expanded = container.dataset.expanded === '1';
    render(container, !expanded);
    const nowExpanded = container.dataset.expanded === '1';
    btn.textContent = nowExpanded ? '-' : '+';
    btn.setAttribute('aria-label', nowExpanded ? 'Show fewer files' : 'Show all files');
    btn.setAttribute('aria-expanded', nowExpanded ? 'true' : 'false');
  });
})();
</script>

<style>
/* Make the comment column the longest and allow wrapping */
.comments-table{table-layout:fixed;width:100%}
.comments-table th:nth-child(1),
.comments-table td:nth-child(1){width:70%}
.comments-table th:nth-child(2),
.comments-table td:nth-child(2){width:5%;white-space:nowrap}
.comments-table th:nth-child(3),
.comments-table td:nth-child(3){width:25%}
.comments-table .comment-cell { word-break: break-word; }
.comments-table .files-cell { display: flex; flex-direction: column; align-items: flex-start; max-width: 100%; overflow-x: auto; }
.comments-table .file-list { display: block; max-width: 100%; }
.comments-table .file-item { display: block; line-height: 1.2; margin-bottom: 1px; white-space: nowrap; font-size: 12px; color: #333; }
.comments-table .more-count { display: block; margin-top: 2px; }
.comments-table td:nth-child(2) { white-space: nowrap; }
.comments-table td:nth-child(3) { white-space: nowrap; }
/* Grouped view styles */
.comments-table .group{margin-bottom:6px}
.comments-table .group-head{display:flex;align-items:center;gap:8px;font-size:12px;color:#6c757d;margin-bottom:2px}
.comments-table .group-label{font-weight:600;color:#555}
.comments-table .group-count{background:#e9ecef;color:#495057;border-radius:999px;padding:2px 6px;font-size:11px}
.comments-table .group-files{margin-left:8px}
</style>
{% endblock %}

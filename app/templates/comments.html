{% extends 'base.html' %}

{% block bodyClass %}comments{% endblock %}
{% block title %}Pabulib – Comments{% endblock %}

{% block body %}
<section class="max-w-4xl mx-auto px-4">
  <div class="flex justify-center">
    <div class="w-full max-w-4xl bg-white rounded-lg shadow-lg p-8 mt-8 mb-32">
      <h1 class="text-3xl font-bold text-slate-800 mb-6">Comments</h1>
      <p class="text-gray-600 mb-6">Parsed from META key <code class="bg-gray-100 px-2 py-1 rounded text-sm">comment</code> using pattern <code class="bg-gray-100 px-2 py-1 rounded text-sm">#n:</code> segments. Showing how many PB files share each comment.</p>

      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 border-b border-gray-200" style="width:45%">Comment</th>
              <th class="px-4 py-4 text-center text-sm font-semibold text-gray-700 border-b border-gray-200" style="width:10%"># files</th>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 border-b border-gray-200" style="width:45%">
                <div class="flex items-center gap-3">
                  <span>Files</span>
                  <label class="flex items-center gap-2 text-xs font-normal text-gray-500">
                    Group by
                    <select id="groupMode" class="text-xs px-2 py-1 border border-gray-300 rounded bg-white text-gray-700">
                      <option value="none">None</option>
                      <option value="country">Country</option>
                      <option value="country_unit" selected>Country + Unit</option>
                      <option value="country_unit_instance">Country + Unit + Instance</option>
                    </select>
                  </label>
                </div>
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for comment, count, files in rows %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 text-sm text-gray-900">{{ comment }}</td>
              <td class="px-4 py-4 text-center">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-800">{{ count }}</span>
              </td>
              <td class="px-6 py-4">
                {% set preview = files[:5] %}
                <div class="files-cell">
                  <div class="file-list text-sm"
                    data-files='{{ files|tojson|e }}'
                    data-groups-country='{{ (groups_by_comment_country.get(comment) or [])|tojson|e }}'
                    data-groups-country-unit='{{ (groups_by_comment_country_unit.get(comment) or [])|tojson|e }}'
                    data-groups-country-unit-instance='{{ (groups_by_comment_country_unit_instance.get(comment) or [])|tojson|e }}'
                    data-expanded="0"></div>
                  {% if files|length > preview|length %}
                    <button type="button" class="mt-2 px-3 py-1 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded hover:bg-blue-100 btn-expand" aria-label="Show all files" aria-expanded="false">+ Show more</button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<script>
// Expand/collapse behavior for files list (+ to expand, − to collapse)
(function(){
  const PREVIEW_COUNT = 5;
  function getGroupMode(){ const el = document.getElementById('groupMode'); return el ? el.value : 'none'; }
  function renderFilesFlat(container, files, expanded){
    if(expanded){
      container.innerHTML = files.map(f => `<span class="file-item">${f}</span>`).join('');
      container.dataset.expanded = '1';
    } else {
      const rest = Math.max(files.length - PREVIEW_COUNT, 0);
      const preview = files.slice(0, PREVIEW_COUNT).map(f => `<span class="file-item">${f}</span>`).join('');
      const more = rest > 0 ? `<span class="more-count text-muted">+ ${rest} more</span>` : '';
      container.innerHTML = preview + more;
      container.dataset.expanded = '0';
    }
  }
  function renderFilesGrouped(container, groups, expanded){
    // groups: [{label, count, files}]
    let html = '';
    const toRender = expanded ? groups : groups.slice(0, 3);
    toRender.forEach(g => {
      const list = (expanded ? g.files : g.files.slice(0, Math.max(2, Math.ceil(PREVIEW_COUNT/Math.max(1, toRender.length)))));
      html += `<div class="group">
        <div class="group-head"><span class="group-label">${g.label || '—'}</span><span class="group-count">${g.count}</span></div>
        <div class="group-files">${list.map(f=>`<span class="file-item">${f}</span>`).join('')}</div>
      </div>`;
    });
    if(!expanded){
      const restGroups = Math.max(groups.length - toRender.length, 0);
      if(restGroups > 0){
        html += `<span class="more-count text-muted">+ ${restGroups} more groups</span>`;
      }
    }
    container.innerHTML = html;
    container.dataset.expanded = expanded ? '1' : '0';
  }
  function render(container, expanded){
    let files = [], groups = [];
    try{ files = JSON.parse(container.getAttribute('data-files')||'[]') || []; }catch(e){ files=[]; }
    const mode = getGroupMode();
    if(mode === 'country'){
      try{ groups = JSON.parse(container.getAttribute('data-groups-country')||'[]') || []; }catch(e){ groups=[]; }
    }else if(mode === 'country_unit'){
      try{ groups = JSON.parse(container.getAttribute('data-groups-country-unit')||'[]') || []; }catch(e){ groups=[]; }
    }else if(mode === 'country_unit_instance'){
      try{ groups = JSON.parse(container.getAttribute('data-groups-country-unit-instance')||'[]') || []; }catch(e){ groups=[]; }
    }else{
      groups = [];
    }
    const grouped = (mode !== 'none') && groups && groups.length;
    if(grouped){
      renderFilesGrouped(container, groups, expanded);
    } else {
      renderFilesFlat(container, files, expanded);
    }
  }
  // Initial render for all rows
  document.querySelectorAll('.file-list').forEach(el => render(el, false));
  // Toggle handler
  addEventListener('change', (e)=>{
    if(e.target && e.target.id === 'groupMode'){
      document.querySelectorAll('.file-list').forEach(el => {
        const expanded = el.dataset.expanded === '1';
        render(el, expanded);
      });
    }
  });
  addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-expand');
    if (!btn) return;
    const wrap = btn.closest('.files-cell'); // robust parent lookup
    const container = wrap && wrap.querySelector('.file-list');
    if (!container) return;
    const expanded = container.dataset.expanded === '1';
    render(container, !expanded);
    const nowExpanded = container.dataset.expanded === '1';
    btn.textContent = nowExpanded ? '-' : '+';
    btn.setAttribute('aria-label', nowExpanded ? 'Show fewer files' : 'Show all files');
    btn.setAttribute('aria-expanded', nowExpanded ? 'true' : 'false');
  });
})();
</script>

<style>
/* Enhanced styles for better readability */
.files-cell { 
  display: flex; 
  flex-direction: column; 
  align-items: flex-start; 
  max-width: 100%; 
}
.file-list { 
  display: block; 
  max-width: 100%; 
  line-height: 1.4;
}
.file-item { 
  display: inline-block; 
  margin-right: 8px;
  margin-bottom: 4px;
  padding: 2px 8px;
  background: #f3f4f6;
  border-radius: 4px;
  font-size: 12px; 
  color: #374151;
  border: 1px solid #e5e7eb;
}
.more-count { 
  display: block; 
  margin-top: 4px; 
  font-size: 12px;
  color: #6b7280;
  font-style: italic;
}
/* Grouped view styles */
.group {
  margin-bottom: 12px;
  padding: 8px;
  background: #f9fafb;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}
.group-head {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #4b5563;
  margin-bottom: 6px;
  font-weight: 500;
}
.group-label {
  font-weight: 600;
  color: #374151;
}
.group-count {
  background: #dbeafe;
  color: #1e40af;
  border-radius: 999px;
  padding: 2px 8px;
  font-size: 11px;
  font-weight: 500;
}
.group-files {
  margin-left: 0;
}
</style>
{% include 'footer.html' %}
{% endblock %}

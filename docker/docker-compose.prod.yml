# Production override for docker/docker-compose.yml
# Use with: docker compose -f docker/docker-compose.yml -f docker/docker-compose.prod.yml up

services:
  web:
    environment:
      ENVIRONMENT: production
      FLASK_DEBUG: 0
    ports:
      # MODIFIED PORTS for CBIP integration - NOT standard 80/443
      # These ports are used internally and proxied by Apache
      - "19080:80"     # HTTP redirect server (internal port for Apache proxy)
      - "19443:443"    # HTTPS main server (internal port for Apache proxy)
    volumes:
      # Mount SSL certificates from Let's Encrypt
      # NOTE: SSL termination could be handled by Apache instead of Docker
      # but this allows the container to handle HTTPS directly for port 19443
      - /etc/letsencrypt:/etc/letsencrypt:ro
      # Mount application code for live updates
      - ../app:/app/app
      - ../scripts:/app/scripts
      - ../requirements.txt:/app/requirements.txt
      - ../run.py:/app/run.py
      - ../app/wsgi.py:/app/app/wsgi.py
      - ../deployment/gunicorn_config.py:/app/deployment/gunicorn_config.py
      - ../docs:/app/docs
      # Host path for PB files -> container path used by the app
      - ${PB_FILES_DIR:-../pb_files}:/app/pb_files
      # Archive (depreciated) files folder
      - ${PB_FILES_DEPRECIATED_DIR:-../pb_files_depreciated}:/app/pb_files_depreciated
      # Cache folder for exports and admin zip jobs
      - ../cache:/app/cache
    restart: unless-stopped
    
  db:
    restart: unless-stopped
    volumes:
      - db_data:/var/lib/mysql
      # Optional: backup location
      # - /home/pabulib/mysql_backups:/backups

  # Remove adminer in production for security
  adminer:
    profiles:
      - debug  # Only start with --profile debug
